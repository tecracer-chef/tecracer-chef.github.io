<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Mocking data in Test Kitchen | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/2020/08/mocking-data-in-test-kitchen.html><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Mocking data in Test Kitchen"><meta property="og:url" content="https://tecracer-chef.github.io/2020/08/mocking-data-in-test-kitchen.html"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/2020/08/mocking-data-in-test-kitchen.html"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(img/2020/08/suzanne-d-williams-5NGIlTOZLaw-unsplash.jpg)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>07</span>
<span class=tm-article-date-month>Aug</span></div><h1 class=uk-article-title>Mocking data in Test Kitchen</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><p>The more complex your cookbooks, the bigger the need to supply some external information to your test machines. Passing specific attributes, values of databags or secrets for testing become necessary. We will go through these use cases and show how to mock the data in this post.</p><h2 id=attributes>Attributes</h2><p>This is the easiest use case and you have probably seen it on numerous tutorials: You have a cookbook which has different execution paths depending on some attribute value. A common one would be to specify the edition of an SQL Server you want to install. While the recipe might be the same, you can manage the distinction between Express, Standard and Enterprise by just changing an attribute.</p><p>So let&rsquo;s say this is our hypothetical resource:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>sql_server <span style=color:#ba2121>&#39;Install SQL Server&#39;</span> <span style=color:green;font-weight:700>do</span>
</span></span><span style=display:flex><span>  action <span style=color:#19177c>:install</span>
</span></span><span style=display:flex><span>  edition node<span style=color:#666>[</span><span style=color:#ba2121>&#39;sql_server&#39;</span><span style=color:#666>][</span><span style=color:#ba2121>&#39;edition&#39;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>end</span>
</span></span></code></pre></div><p>By setting the <code>sql_server/edition</code> attribute we can influence if this is machine gets a Standard or Enterprise edition. Of course we want to test both. To do this, we can just add two suites to our Test Kitchen configuration file and supply the attribute<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>suites</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>standard<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>provider</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>run_list</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span>- recipe[sql_server::configure]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>attributes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span><span style=color:green;font-weight:700>sql_server</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>         </span><span style=color:green;font-weight:700>edition</span>:<span style=color:#bbb> </span>standard<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>enterprise<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>provider</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>run_list</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span>- recipe[sql_server::configure]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>attributes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span><span style=color:green;font-weight:700>sql_server</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>         </span><span style=color:green;font-weight:700>edition</span>:<span style=color:#bbb> </span>enterprise<span style=color:#bbb>
</span></span></span></code></pre></div><p>That&rsquo;s everything needed. The Chef provisioners will automatically pull in those attributes and make them available to your cookbooks under test.</p><h2 id=data-bags>Data Bags</h2><p>When it comes to central configuration, for example some values which multiple nodes need to access, Data Bags are the way to go. We could save some License Key in there:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>licenses <span style=color:#666>=</span> data_bag_item(<span style=color:#ba2121>&#39;licenses&#39;</span>, <span style=color:#ba2121>&#39;microsoft&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sql_server <span style=color:#ba2121>&#39;Install SQL Server&#39;</span> <span style=color:green;font-weight:700>do</span>
</span></span><span style=display:flex><span>  action <span style=color:#19177c>:install</span>
</span></span><span style=display:flex><span>  edition node<span style=color:#666>[</span><span style=color:#ba2121>&#39;sql_server&#39;</span><span style=color:#666>][</span><span style=color:#ba2121>&#39;edition&#39;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span>  license licenses<span style=color:#666>[</span><span style=color:#ba2121>&#39;sql_server&#39;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>end</span>
</span></span></code></pre></div><p>In Test Kitchen we can mock this easily, as well:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>suites</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>standard<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>provisioner</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>run_list</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span>- recipe[sql_server::configure]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>attributes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span><span style=color:green;font-weight:700>sql_server</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>         </span><span style=color:green;font-weight:700>edition</span>:<span style=color:#bbb> </span>standard<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>data_bag_path</span>:<span style=color:#bbb> </span>test/integration/data_bags/<span style=color:#bbb> </span><span style=color:#408080;font-style:italic># this is actually the default location</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>The directory <code>test/integration/data_bags/</code> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> contains a subdirectory <code>licenses</code> (the data bag name) and a file <code>microsoft.json</code> (the item name) and this contains:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;sql_server&#34;</span>: <span style=color:#ba2121>&#34;...&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The most complicated thing about this is to remember the location of the databag and the <code>databag/item.json</code> naming hierarchy.</p><h2 id=chef-vault>Chef Vault</h2><p>Of course we wouldn&rsquo;t want our precious license keys (or passwords) out in the open like in the Data Bag example <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. The easiest way to avoid this is using <a href=https://docs.chef.io/workstation/chef_vault/>Chef Vault</a>. It automatically creates encrypted databags and you can assign privileges on which node may access which data bag.</p><p>As our Test Kitchen instances are not bootstrapped against a server and we don&rsquo;t want to work with real data in our tests anyway, using Chef Vault here is no option. Outside of testing, accessing Vault is ok but in testing we should never interface with productions systems, right?</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>licenses <span style=color:#666>=</span> chef_vault_item(<span style=color:#ba2121>&#39;licenses&#39;</span>, <span style=color:#ba2121>&#39;microsoft&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sql_server <span style=color:#ba2121>&#39;Install SQL Server&#39;</span> <span style=color:green;font-weight:700>do</span>
</span></span><span style=display:flex><span>  action <span style=color:#19177c>:install</span>
</span></span><span style=display:flex><span>  edition node<span style=color:#666>[</span><span style=color:#ba2121>&#39;sql_server&#39;</span><span style=color:#666>][</span><span style=color:#ba2121>&#39;edition&#39;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span>  license licenses<span style=color:#666>[</span><span style=color:#ba2121>&#39;sql_server&#39;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>end</span>
</span></span></code></pre></div><p>Luckily, the developers of <code>chef_vault</code> have implemented a fallback so we can use our Data Bag knowledge here:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>suites</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>standard<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>provisioner</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>run_list</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span>- recipe[sql_server::configure]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>data_bag_path</span>:<span style=color:#bbb> </span>test/integration/data_bags/<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>attributes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span><span style=color:green;font-weight:700>chef_vault</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>         </span><span style=color:green;font-weight:700>data_bag_fallback</span>:<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>We didn&rsquo;t have to change our databag, only tell the helpers that a fallback is to be used. On a Chef Infra Server, we would still access the central data in the same way. It&rsquo;s only the Kitchen configuration which makes the switch.</p><p><strong>Don&rsquo;t use Chef Vault in production</strong></p><p>Chef Vault does not scale well, as it encrypts all secrets with a secret key per node. That leads to (#nodes) * (#secrets) different values and it&rsquo;s easy to see that this won&rsquo;t work beyond a handful of nodes.</p><p>For production setups, Hashicorp Vault is the recommended tool and is well-integrated with the Chef ecosysem.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Curious about why this is under provisioner? It&rsquo;s the &ldquo;new&rdquo; style from 2013. I wrote a <a href=https://aws-blog.de/2020/06/update-your-style-in-test-kitchen.html>blog on Kitchen style</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Not sure about the default path? <a href=https://github.com/test-kitchen/test-kitchen/blob/v1.3.0/lib/kitchen/provisioner/chef_base.rb#L54-L56>Definition in Chef base provisioner</a> -> <a href=https://github.com/test-kitchen/test-kitchen/blob/v1.3.0/lib/kitchen/configurable.rb#L97>Lookup method</a> -> <a href=https://github.com/test-kitchen/test-kitchen/blob/v1.3.0/lib/kitchen.rb#L111>Default test path</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>It is worth mentioning that you can also use encrypted databags. The procedure for this is a bit more complicated and there are other <a href=http://atomic-penguin.github.io/blog/2013/06/07/HOWTO-test-kitchen-and-encrypted-data-bags/>blog entries like from atomic-penguin</a> on setting it up. Test Kitchen has an integration for this, but be careful about accidentally committing secrets to GIT.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a>
<a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a>
<a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a>
<a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div></div></div></body></html>