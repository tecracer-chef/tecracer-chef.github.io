<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Chef Interactive | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/2019/06/chef-interactive/><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Chef Interactive"><meta property="og:url" content="https://tecracer-chef.github.io/2019/06/chef-interactive/"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/2019/06/chef-interactive/"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script><script src=https://tecracer-chef.github.io/js/uikit.min.js></script><script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/>Blog</a></li><li><a href=/authors>Authors</a></li><li><a href=/github/github-prs.html>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(/img/2019/06/sergi-kabrera-2xU7rYxsTiM-unsplash.jpg)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>07</span>
<span class=tm-article-date-month>Jun</span></div><h1 class=uk-article-title>Chef Interactive</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><p>As you probably are aware, <a href=https:%5Cchef.io>Chef</a> is a tool which is meant for automatic provisioning and configuring of systems. So if you have a particular problem falling outside of the regular use cases, both posts on the internet and support enquiries of any kind will probably result in one of two answers: &ldquo;that is not possible&rdquo; or &ldquo;you are doing it wrong&rdquo;.</p><p>But - what if you really need this for a rather exotic task or even as an transitory solution?</p><h1 id=use-cases>Use Cases</h1><p>So far, we have seen two specific use cases: Modernization of a provisioning workflow and use of tools with purely interactive setups.</p><p>Think of a factory where IT systems are provisioned as part of a larger engineering solution. Certainly, these IT systems are only a part of this system and probably even one that&rsquo;s deemed non-central to the solution. Especially if the provisioning\production workflow is outsourced to a third party, you have to follow some constraints until more sophisticated solutions can be deployed. Sure, aiming for a &ldquo;Big Bang&rdquo; release which will completely change and optimize everything is an option. But in an enterprise context - how often does that usually go well?</p><p>So, in our less-than-hypothetical case we will imagine such a workflow where people are currently used to start a newly installed Windows server and then follow tasks such as checking\configuring parts of the system. Most of this we can replace with a Chef based solution. But what if there are cases where servers arrive with the wrong number of physical drives? Or we have variations which only can be corrected in some manual fashion? Usually, an assembly line should not have this problems - if you followed the Lean movement, you probably know the <a href=https://www.lean.org/lexicon/jidoka>Jidoka principle</a>. But for now, let&rsquo;s say this is something we cannot influence at the point of the project, so we have to work with that.</p><p>You probably know one or two of those already: Setup tools which for some reason do not support any non-interactive setup. No flags on the installer or even some mandatory pop-up asking for an activation key. One of the pragmatic solutions is to use tools like <a href=https://www.autoitscript.com/site/autoit>AutoIt</a> or <a href=https://www.autohotkey.com>AutoHotkey</a> to wait for window events, simulate keystrokes or mouse clicks.</p><p>Our core problem in this case is, that Chef is executed as a background process and in a headless session. Not even a simulated UI - that means our AutoIt won&rsquo;t work either.</p><h1 id=step-1-get-interactive>Step 1: Get Interactive</h1><p>There are two approaches which we came up with: one works with a tool from the Sysinternals suite by Microsoft called &ldquo;psexec&rdquo; and another one which only uses Windows-internal means to do the job. Both solutions require an interactive Windows session though, so we have to tackle this one first.</p><p>Windows systems have the ability to automatically login a user on system boot. Obviously, that is a bad idea security-wise - but in our use case, we are in a one-off provisioning workflow, so that is a bearable thing if it gets removed afterwards. Right?</p><p>There currently is no resource in Chef to activate\deactivate Autologin. But that is no problem, as we can write a simple Custom Resource around a <a href=https:%5Cdocs.chef.io%5Cresource_registry_key.html>registry_key resource</a> setting the appropriate values:</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>resource_name <span style=color:#19177c>:autologin</span>
 
property <span style=color:#19177c>:user</span>, <span style=color:green>String</span>, <span style=color:#19177c>name_property</span>: <span style=color:green>true</span>
property <span style=color:#19177c>:password</span>, <span style=color:green>String</span>
 
default_action <span style=color:#19177c>:enable</span>
 
action <span style=color:#19177c>:enable</span> <span style=color:green;font-weight:700>do</span>
  registry_key <span style=color:#ba2121>&#39;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#39;</span> <span style=color:green;font-weight:700>do</span>
    values <span style=color:#666>[</span>
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultUserName&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: new_resource<span style=color:#666>.</span>user },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultPassword&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: new_resource<span style=color:#666>.</span>password },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;AutoAdminLogon&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:dword</span>, <span style=color:#19177c>data</span>: <span style=color:#666>1</span> },
    <span style=color:#666>]</span>
    sensitive <span style=color:green>true</span>
    action <span style=color:#19177c>:create</span>
    notifies <span style=color:#19177c>:reboot_now</span>, <span style=color:#ba2121>&#39;reboot[now]&#39;</span>, <span style=color:#19177c>:immediate</span>
  <span style=color:green;font-weight:700>end</span>
 
  reboot <span style=color:#ba2121>&#39;now&#39;</span> <span style=color:green;font-weight:700>do</span>
    action <span style=color:#19177c>:nothing</span>
  <span style=color:green;font-weight:700>end</span>
<span style=color:green;font-weight:700>end</span>
 
action <span style=color:#19177c>:disable</span> <span style=color:green;font-weight:700>do</span>
  registry_key <span style=color:#ba2121>&#39;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#39;</span> <span style=color:green;font-weight:700>do</span>
    values <span style=color:#666>[</span>
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultUserName&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: <span style=color:#ba2121>&#39;&#39;</span> },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultPassword&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: <span style=color:#ba2121>&#39;&#39;</span> },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;AutoAdminLogon&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:dword</span>, <span style=color:#19177c>data</span>: <span style=color:#666>0</span> },
    <span style=color:#666>]</span>
    action <span style=color:#19177c>:create</span>
  <span style=color:green;font-weight:700>end</span>
<span style=color:green;font-weight:700>end</span>
</code></pre></div><p>As you can see, we also have a conditional reboot resource in this and it really means that the system is going to restart at this point in time. Another thing: user and password are in the registry in clear text! No other way to achieve this as far as I am aware, though.</p><p>If you use this resource, always keep in mind that</p><ul><li>you deactivate autologin after you are done (no reboot required there)</li><li>a rerun of this will always reboot the server and go through this unless you add a proper guard to it (for example check for a registry key, if the program in question is already installed)</li></ul><h1 id=step-2-schedule-that-task>Step 2: Schedule That Task</h1><p>Now how to execute a resource after the server booted up? You might have already guessed from the title - we will use the Windows Task Scheduler now. One of the ways it can be configured will work for us. This needs:</p><ul><li>set the task to &ldquo;on logon&rdquo;, so it will actually start</li><li>property &ldquo;Start when a user is logged on&rdquo; (we covered that with our autologin resource before)</li><li>user\password for the task</li></ul><p>As we want this in the same session which we are logged in, we will just snatch the user\password values from our autologin registry key. So no duplication of access data and we even made use of the rather ugly cleartext storage. The Chef <a href=https:%5Cdocs.chef.io%5Cresource_windows_task.html>windows_task resource</a> is making our setup pretty easy.</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>resource_name <span style=color:#19177c>:execute_interactive</span>
 
property <span style=color:#19177c>:command</span>, <span style=color:green>String</span>, <span style=color:#19177c>name_property</span>: <span style=color:green>true</span>
 
default_action <span style=color:#19177c>:enable</span>
 
action <span style=color:#19177c>:enable</span> <span style=color:green;font-weight:700>do</span>
  <span style=color:green>require</span> <span style=color:#ba2121>&#39;securerandom&#39;</span>
 
  <span style=color:#408080;font-style:italic># Extract from autologin settings</span>
  autologin <span style=color:#666>=</span> registry_get_values(<span style=color:#ba2121>&#39;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#39;</span>)
  user_auto <span style=color:#666>=</span> autologin<span style=color:#666>.</span>select { <span style=color:#666>|</span>data<span style=color:#666>|</span> data<span style=color:#666>[</span><span style=color:#19177c>:name</span><span style=color:#666>]</span> <span style=color:#666>==</span> <span style=color:#ba2121>&#39;DefaultUserName&#39;</span> }<span style=color:#666>.</span>first<span style=color:#666>[</span><span style=color:#19177c>:data</span><span style=color:#666>]</span>
  password_auto <span style=color:#666>=</span> autologin<span style=color:#666>.</span>select { <span style=color:#666>|</span>data<span style=color:#666>|</span> data<span style=color:#666>[</span><span style=color:#19177c>:name</span><span style=color:#666>]</span> <span style=color:#666>==</span> <span style=color:#ba2121>&#39;DefaultPassword&#39;</span> }<span style=color:#666>.</span>first<span style=color:#666>[</span><span style=color:#19177c>:data</span><span style=color:#666>]</span>
  taskname <span style=color:#666>=</span> <span style=color:green>format</span>(<span style=color:#ba2121>&#39;execute-interactive-%s&#39;</span>, <span style=color:#800>SecureRandom</span><span style=color:#666>.</span>hex(<span style=color:#666>4</span>))
 
  windows_task <span style=color:#ba2121>&#39;Create task &#39;</span> <span style=color:#666>+</span> taskname <span style=color:green;font-weight:700>do</span>
    action <span style=color:#666>[</span><span style=color:#19177c>:create</span>, <span style=color:#19177c>:run</span><span style=color:#666>]</span>
    task_name taskname
    command new_resource<span style=color:#666>.</span>command
 
    interactive_enabled <span style=color:green>true</span>
    user user_auto
    password password_auto
    sensitive <span style=color:green>true</span>
 
    run_level <span style=color:#19177c>:highest</span>
    frequency <span style=color:#19177c>:once</span>
    start_time <span style=color:#800>Time</span><span style=color:#666>.</span>now<span style=color:#666>.</span>strftime(<span style=color:#ba2121>&#39;%H:%M&#39;</span>)
  <span style=color:green;font-weight:700>end</span>
 
  powershell_script <span style=color:#ba2121>&#39;Wait for completion of &#39;</span> <span style=color:#666>+</span> taskname <span style=color:green;font-weight:700>do</span>
    action <span style=color:#19177c>:run</span>
    code <span style=color:#666>&lt;&lt;~</span><span style=color:#800>PS1</span>
      <span style=color:#800>Do</span> {
        <span style=color:#800>Start</span><span style=color:#666>-</span><span style=color:#800>Sleep</span> <span style=color:#666>-</span><span style=color:#800>Seconds</span> <span style=color:#666>1</span>
      } <span style=color:green;font-weight:700>while</span> ((<span style=color:#800>Get</span><span style=color:#666>-</span><span style=color:#800>ScheduledTaskInfo</span> <span style=color:#666>-</span><span style=color:#800>TaskName</span> <span style=color:#408080;font-style:italic>#{taskname}).LastTaskResult -ge 0x41301)</span>
    <span style=color:#800>PS1</span>
  <span style=color:green;font-weight:700>end</span>
 
  windows_task <span style=color:#ba2121>&#39;Remove task &#39;</span> <span style=color:#666>+</span> taskname <span style=color:green;font-weight:700>do</span>
    task_name taskname
    action <span style=color:#19177c>:delete</span>
  <span style=color:green;font-weight:700>end</span>
<span style=color:green;font-weight:700>end</span>
</code></pre></div><p>To be honest, this is the bare minimum and our implementation is a bit more sophisticated than that. But it works! Notice, that this will always result in converged resources due to adding/removing the task - so if you check for that inside your pipeline, keep that in mind.</p><p>If you are going into AutoIt\AutoHotkey land, I would advise you to write a custom resource which only accepts the script source, so you get more of the Infrastructure as Code vibe. For an advanced Chef engineer, that should pose not significant problem to write.</p><h2 id=alternative-psexec>Alternative: PSExec</h2><p>Another way that would work is using the Sysinternals Tools by Microsoft, which include a <a href=https:%5Cdocs.microsoft.com%5Cen-us%5Csysinternals%5Cdownloads%5Cpsexec>tool to execute tasks</a>. That tool includes switches for interactive use and running under a system account. So if you for some reason dislike the task manager solution and are fine with somehow bundling an executable with your cookbook, you can certainly go down that path. It will still use the same autologin resource, but only the implementation for our execute_interactive resource will differ by using an execute resource instead of windows_task</p><h1 id=summary>Summary</h1><p>Even though people (rightfully) want you not to run programs interactively with Chef, it is certainly possible. It should always be a matter of last resort or a transitional step towards a more elegant solution. In our factory example, you could either prevent variation in process step inputs or change the underlying principle, e.g. via using virtualized servers with automatic deployment of VMware ESX and all needed images.</p></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a><a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a><a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a><a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a><img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/>Blog</a></li><li><a href=/authors>Authors</a></li><li><a href=/github/github-prs.html>Pull Requests</a></li></ul></div></div></div></body></html>