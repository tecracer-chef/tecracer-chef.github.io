<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Custom Resource Diffs in Chef | tecRacer Chef</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=canonical href=https://tecracer-chef.github.io/2019/09/custom-resource-diffs-in-chef.html>
<meta http-equiv=content-language content="en-us">
<meta property="og:type" content="website">
<meta property="og:site_name" content="tecRacer Chef">
<meta property="og:title" content="Custom Resource Diffs in Chef">
<meta property="og:url" content="https://tecracer-chef.github.io/2019/09/custom-resource-diffs-in-chef.html">
<meta property="og:image" content="https://tecracer-chef.github.io/images/">
<meta name=twitter:title content="tecRacer Chef">
<meta name=twitter:url content="https://tecracer-chef.github.io/2019/09/custom-resource-diffs-in-chef.html">
<meta name=twitter:image content="https://tecracer-chef.github.io/images/">
<meta name=twitter:card content>
<link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml>
<link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet>
<script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script>
</head>
<body>
<div class="uk-container uk-container-center">
<div class=tm-header>
<div class="tm-toolbar uk-clearfix uk-hidden-small">
<div class=uk-float-right>
<div class=uk-panel>
<ul class=uk-subnav>
<li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li>
<li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li>
<li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li>
<li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li>
<li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li>
</ul>
</div>
</div>
</div>
<nav class=uk-navbar>
<a class=uk-navbar-brand href=/>
<img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
</a>
<div class=uk-hidden-small>
<ul class=uk-navbar-nav>
<li><a href=/ title>Blog</a></li>
<li><a href=/authors title>Authors</a></li>
<li><a href=/github/github-prs.html title>Pull Requests</a></li>
</ul>
</div>
<div class="uk-navbar-flip uk-visible-small">
<a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a>
</div>
</nav>
</div>
<div id=content>
<main id=tm-content class=tm-content>
<article class=uk-article>
<div class="tm-article-featured-image uk-cover-background" style=background-image:url(/img/2019/09/sharon-mccutcheon-o2glCCYUCe8-unsplash.jpg)></div>
<div class="tm-article-content uk-position-relative">
<div class="tm-article-date uk-text-center">
<span class=tm-article-date-day>
13
</span>
<span class=tm-article-date-month>
Sep
</span>
</div>
<h1 class=uk-article-title>Custom Resource Diffs in Chef</h1>
<p class=uk-article-meta>
Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a>
</p>
<div class=uk-margin>
<h1 id=custom-resource-diffs-in-chef>Custom Resource Diffs in Chef</h1>
<p>If you are writing custom resources regularly, you might have been annoyed by a general &ldquo;diff&rdquo; functionality in Chef. In this post we will work on some snippets to make this possible</p>
<p>While the <code>file</code> and <code>template</code> resources will output an overview of added/removed/changed lines during the Chef run, there is no built-in facility for your own resources.</p>
<p>In my current project I am working heavily with Chef Target Mode (you might have noticed from the last posts), so I cannot simply use the existing resources for change output.</p>
<h2 id=current-state>Current state</h2>
<p>Chef bundles the <a href=https://github.com/halostatue/diff-lcs>Diff::LCS</a> gem for it&rsquo;s output on the mentioned resources, so there is no external dependency needed.</p>
<p>When searching for built-in functionality, I discovered some code lines in <a href=https://github.com/chef/chef/blob/303282f31ea20ff5dcdefe42e19c0bb8a42f4178/lib/chef/resource_reporter.rb#L39>Chef::ResourceReporter</a> and <a href=https://github.com/chef/chef/blob/7558c414030d082194d0d2b5f74279ce151517e9/lib/chef/data_collector/run_end_message.rb#L116>Chef::DataCollector::RunEndMessage</a> which are checking if a resource responds to a <code>diff</code> method call. Sadly, I was not able to make this work.</p>
<p>I also found that the existing code in <a href=https://github.com/chef/chef/blob/7558c414030d082194d0d2b5f74279ce151517e9/lib/chef/util/diff.rb>Chef::Util::Diff</a> does only work with local files and not string input.</p>
<h2 id=customized-diff-method>Customized Diff Method</h2>
<p>Our new method is basically some copy & paste from the Chef::Util::Diff#udiff resource with it&rsquo;s file-specific lines removed.</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:green;font-weight:700>def</span> <span style=color:#00f>str_udiff</span>(old_data, new_data)
  diff_str <span style=color:#666>=</span> <span style=color:#ba2121>&#34;&#34;</span>
  file_length_difference <span style=color:#666>=</span> <span style=color:#666>0</span>

  diff_data <span style=color:#666>=</span> <span style=color:#666>::</span><span style=color:#800>Diff</span><span style=color:#666>::</span><span style=color:#800>LCS</span><span style=color:#666>.</span>diff(old_data, new_data)

  <span style=color:green;font-weight:700>return</span> diff_str <span style=color:green;font-weight:700>if</span> old_data<span style=color:#666>.</span>empty? <span style=color:#666>&amp;&amp;</span> new_data<span style=color:#666>.</span>empty?
  <span style=color:green;font-weight:700>return</span> <span style=color:#ba2121>&#34;No differences encountered</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span> <span style=color:green;font-weight:700>if</span> diff_data<span style=color:#666>.</span>empty?

  <span style=color:#408080;font-style:italic># loop over diff hunks. if a hunk overlaps with the last hunk,</span>
  <span style=color:#408080;font-style:italic># join them. otherwise, print out the old one.</span>
  old_hunk <span style=color:#666>=</span> hunk <span style=color:#666>=</span> <span style=color:green>nil</span>
  diff_data<span style=color:#666>.</span>each <span style=color:green;font-weight:700>do</span> <span style=color:#666>|</span>piece<span style=color:#666>|</span>
    <span style=color:green;font-weight:700>begin</span>
      hunk <span style=color:#666>=</span> <span style=color:#666>::</span><span style=color:#800>Diff</span><span style=color:#666>::</span><span style=color:#800>LCS</span><span style=color:#666>::</span><span style=color:#800>Hunk</span><span style=color:#666>.</span>new(old_data, new_data, piece, <span style=color:#666>3</span>, file_length_difference)
      file_length_difference <span style=color:#666>=</span> hunk<span style=color:#666>.</span>file_length_difference
      <span style=color:green;font-weight:700>next</span> <span style=color:green;font-weight:700>unless</span> old_hunk
      <span style=color:green;font-weight:700>next</span> <span style=color:green;font-weight:700>if</span> hunk<span style=color:#666>.</span>merge(old_hunk)

      diff_str <span style=color:#666>&lt;&lt;</span> old_hunk<span style=color:#666>.</span>diff(<span style=color:#19177c>:unified</span>) <span style=color:#666>&lt;&lt;</span> <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>
    <span style=color:green;font-weight:700>ensure</span>
      old_hunk <span style=color:#666>=</span> hunk
    <span style=color:green;font-weight:700>end</span>
  <span style=color:green;font-weight:700>end</span>
  diff_str <span style=color:#666>&lt;&lt;</span> old_hunk<span style=color:#666>.</span>diff(<span style=color:#19177c>:unified</span>) <span style=color:#666>&lt;&lt;</span> <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>
  diff_str
<span style=color:green;font-weight:700>end</span>
</code></pre></div><p>So by passing in the current and new values into this function, we will get the output we want. Please be aware, that Diff::LCS expects this input to be an array of lines, not a String.</p>
<p>Using this helper is easy in our custom resources:</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  description <span style=color:#666>=</span> <span style=color:#666>[</span><span style=color:#ba2121>&#34;update my configuration&#34;</span><span style=color:#666>]</span>
  description <span style=color:#666>&lt;&lt;</span> str_udiff(
    @current_resource<span style=color:#666>.</span>content<span style=color:#666>.</span>lines(<span style=color:green>chomp</span><span style=color:#19177c>:true</span>),
    @new_resource<span style=color:#666>.</span>content<span style=color:#666>.</span>lines(<span style=color:green>chomp</span><span style=color:#19177c>:true</span>)
  )

  converge_by(description) <span style=color:green;font-weight:700>do</span>
     <span style=color:#408080;font-style:italic># Do your work</span>
  <span style=color:green;font-weight:700>end</span>
</code></pre></div><p>As the <code>lines</code> method preserves line endings, the <code>str_udiff</code> code would result in double newlines. Luckily, there is the <code>chomp</code> option available to fix that.</p>
<p>By using <code>converge_by</code> you can supply a custom description in a custom resource, which is not documented very well.</p>
<h2 id=getting-fancy>Getting Fancy</h2>
<p>The only thing I was not happy about with this solution is the missing eye candy. I would love to have some output which marks removed lines in red and added lines in green. While I was browsing for Rubygems to use (before realizing Chef already bundled something), I found the excellent <a href=https://github.com/samg/diffy>samg/diffy</a> tool. This one already includes some code for coloring diff output in its <a href=https://github.com/samg/diffy/blob/master/lib/diffy/format.rb#L4-L19>diffy/format.rb file</a>.</p>
<p>We can use that code with slight adjustments to have a diff function with ANSI colors:</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:green;font-weight:700>def</span> <span style=color:#00f>diff</span>(current, <span style=color:green>new</span>)
  diff <span style=color:#666>=</span> <span style=color:#800>Chef</span><span style=color:#666>::</span><span style=color:#800>Util</span><span style=color:#666>::</span><span style=color:#800>Diff</span><span style=color:#666>.</span>new<span style=color:#666>.</span>str_udiff(
    current<span style=color:#666>.</span>lines(<span style=color:green>chomp</span>: <span style=color:green>true</span>),
    <span style=color:green>new</span><span style=color:#666>.</span>lines(<span style=color:green>chomp</span>: <span style=color:green>true</span>)
  ) 

  diff<span style=color:#666>.</span>lines<span style=color:#666>.</span>map <span style=color:green;font-weight:700>do</span> <span style=color:#666>|</span>line<span style=color:#666>|</span>
    <span style=color:green;font-weight:700>case</span> line
    <span style=color:green;font-weight:700>when</span> <span style=color:#b68>/^(---|\+\+\+|\\\\)/</span>
      <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[90m</span><span style=color:#b68;font-weight:700>#{</span>line<span style=color:#666>.</span>chomp<span style=color:#b68;font-weight:700>}</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[0m&#34;</span>
    <span style=color:green;font-weight:700>when</span> <span style=color:#b68>/^\+/</span>
      <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[32m</span><span style=color:#b68;font-weight:700>#{</span>line<span style=color:#666>.</span>chomp<span style=color:#b68;font-weight:700>}</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[0m&#34;</span>
    <span style=color:green;font-weight:700>when</span> <span style=color:#b68>/^-/</span>
      <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[31m</span><span style=color:#b68;font-weight:700>#{</span>line<span style=color:#666>.</span>chomp<span style=color:#b68;font-weight:700>}</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[0m&#34;</span>
    <span style=color:green;font-weight:700>when</span> <span style=color:#b68>/^@@/</span>
      <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[36m</span><span style=color:#b68;font-weight:700>#{</span>line<span style=color:#666>.</span>chomp<span style=color:#b68;font-weight:700>}</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[0m&#34;</span>
    <span style=color:green;font-weight:700>else</span>
      <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\033</span><span style=color:#ba2121>[0m</span><span style=color:#b68;font-weight:700>#{</span>line<span style=color:#666>.</span>chomp<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>
    <span style=color:green;font-weight:700>end</span>
  <span style=color:green;font-weight:700>end</span><span style=color:#666>.</span>join(<span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>) <span style=color:#666>+</span> <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>
<span style=color:green;font-weight:700>end</span>
</code></pre></div><p>As this one does the conversion of String into Arrays for us, our use inside the custom resource gets even easier:</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  description <span style=color:#666>=</span> <span style=color:#666>[</span><span style=color:#ba2121>&#34;update my configuration&#34;</span><span style=color:#666>]</span>
  description <span style=color:#666>&lt;&lt;</span> diff(@current_resource<span style=color:#666>.</span>content, @new_resource<span style=color:#666>.</span>content)

  converge_by(description) <span style=color:green;font-weight:700>do</span>
     <span style=color:#408080;font-style:italic># Do your work</span>
  <span style=color:green;font-weight:700>end</span>
</code></pre></div><p>Have fun!</p>
</div>
</div>
</article>
<article class=uk-article>
<div class=container>
<section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person>
<div class="media author-box">
<div class=media-figure>
<img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125>
</div>
<div class=media-body>
<h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2>
<p>
Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.
</p>
<div class=author-icons>
<a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile">
<i class="fas fa-id-card"></i>
</a>
<a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing>
<i class="fab fa-xing"></i>
</a>
<a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn>
<i class="fab fa-linkedin"></i>
</a>
<a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github>
<i class="fab fa-github"></i>
</a>
</div>
</div>
</div>
</section>
</div>
</article>
</main>
</div>
<div id=tm-footer class=tm-footer>
<div id=tm-footer class="tm-footer tm-footer-margin-top">
<div class="uk-panel uk-panel-space uk-text-center">
<p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p>
</div>
</div>
</div><div id=offcanvas class=uk-offcanvas aria-hidden=true>
<div class="uk-offcanvas-bar uk-offcanvas-bar-flip">
<div class="uk-panel uk-text-center">
<a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
</a>
</div>
<ul class="uk-nav uk-nav-offcanvas">
<li><a href=/ title>Blog</a></li>
<li><a href=/authors title>Authors</a></li>
<li><a href=/github/github-prs.html title>Pull Requests</a></li>
</ul>
</div>
</div>
</div>
</body>
</html>