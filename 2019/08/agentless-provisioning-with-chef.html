<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Agentless Provisioning with Chef | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/2019/08/agentless-provisioning-with-chef.html><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Agentless Provisioning with Chef"><meta property="og:url" content="https://tecracer-chef.github.io/2019/08/agentless-provisioning-with-chef.html"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/2019/08/agentless-provisioning-with-chef.html"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(img/2019/08/george-pagan-iii-bIlaTxx4nCo-unsplash.jpg)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>16</span>
<span class=tm-article-date-month>Aug</span></div><h1 class=uk-article-title>Agentless Provisioning with Chef</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><h1 id=agentless-provisioning-with-chef>Agentless Provisioning with Chef</h1><p>One of the main points of criticism about Chef I heard over the last few years has been the need to have an agent deployed at remote machines. Sometimes that is not desired, sometimes it is not even possible.</p><p>Due to this, configuring remote machines has become the stronghold of other tools - but a new feature of Chef changes the landscape fundamentally.</p><h2 id=target-mode>Target Mode</h2><p>The so-called Chef Target Mode arrived with <a href=https://discourse.chef.io/t/chef-infra-client-15-0-293-released/15110>Chef 15.0.293</a> and, while not having been documented properly up to now, has been overshadowed by the EULA changes which broke quite some systems over the net. But that&rsquo;s another story.</p><p><a href=https://github.com/chef-boneyard/chef-rfc/blob/master/rfc112-target-mode.md>Target Mode (RFC112)</a> has been made possible by several changes in the Chef backend, notably including the Train library which is a spin-off from Chef&rsquo;s sister project InSpec. Over there, it has evolved from a mere SSH/WinRM transport layer into a multipurpose tool by itself, including different plugin types which makes it massively extensible. As Chef is allowing a single node to remotely manage multiple systems, this means that mechanics for a <a href=https://github.com/chef-boneyard/chef-rfc/blob/master/rfc099-authentication-config-file.md>Credentials File (RFC099)</a> were needed as well.</p><p>Only a few resources are supported as of August 2019, namely:</p><ul><li><code>apt_package</code></li><li><code>ruby_block</code></li><li><code>log</code></li><li><code>execute</code></li><li><code>service</code></li></ul><p>This list will grow over time, but rather slowly that rapidly as many resources will need updated implementations or even separate execution paths to support remote devices. Still, it is easily possible to write your own custom resources for Target Mode to move ahead.</p><h2 id=the-credentials-file>The credentials file</h2><p>First off, we need to configure the credentials used to access our remote node. As you can use SSH, WinRM or more exotic protocols (only limited by what the Train universe has to offer), there are multiple ways of setting up the necessary login data for your devices. You will find, that the options in your credentials file are the exact same as the ones for the corresponding Train plugin.</p><p>Credential files are looked for in two locations basically: your user-specific <code>~/.chef/credentials file</code> or a system-wide <code>/etc/chef/credentials</code> one. Guard it well with the appropriate access rights or that might turn out bad</p><p><strong>Simple SSH connection with user and password:</strong></p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#ba2121>&#39;192.168.240.123&#39;</span>]
</span></span><span style=display:flex><span>host = <span style=color:#ba2121>&#39;192.168.240.123&#39;</span>
</span></span><span style=display:flex><span>user = <span style=color:#ba2121>&#39;root&#39;</span>
</span></span><span style=display:flex><span>password = <span style=color:#ba2121>&#39;Passw0rd&#39;</span>
</span></span></code></pre></div><p>Note that the hostname has to be quoted to make this work. If something is not right, Chef will notify you about that with some warnings on start.</p><p><strong>More secure is to do SSH with a keyfile:</strong></p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#ba2121>&#39;192.168.240.123&#39;</span>]
</span></span><span style=display:flex><span>host = <span style=color:#ba2121>&#39;192.168.240.123&#39;</span>
</span></span><span style=display:flex><span>user = <span style=color:#ba2121>&#39;root&#39;</span>
</span></span><span style=display:flex><span>key_files = <span style=color:#ba2121>&#39;.chef/ssh/my.key&#39;</span>
</span></span></code></pre></div><p>This will also poll your local ssh-agent automatically, if you have it running.</p><p><strong>And finally:</strong></p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#ba2121>&#39;192.168.240.123&#39;</span>]
</span></span><span style=display:flex><span>host = <span style=color:#ba2121>&#39;192.168.240.123&#39;</span>
</span></span><span style=display:flex><span>user = <span style=color:#ba2121>&#39;root&#39;</span>
</span></span><span style=display:flex><span>password = <span style=color:#ba2121>&#39;Passw0rd&#39;</span>
</span></span><span style=display:flex><span>bastion_host = <span style=color:#ba2121>&#39;jumpserver.example.com&#39;</span>
</span></span><span style=display:flex><span>bastion_user = <span style=color:#ba2121>&#39;jdoe&#39;</span>
</span></span><span style=display:flex><span>verify_host_key = <span style=color:green;font-weight:700>true</span>
</span></span></code></pre></div><p>You might have devices which you can only reach via a jump host/bastion server or whatever you want to call it. Train already has that covered.</p><p>The SSH connection options can be found in the <a href=https://github.com/inspec/train/blob/master/lib/train/transports/ssh.rb>Train SSH source code on Github</a></p><h2 id=a-simple-cookbook>A Simple Cookbook</h2><p>How to write a cookbook is not part of this post, that should be covered in the Chef basics. If you do not know how a cookbook really works, contact us and either book a seat in our regular Chef Foundations trainings in Hannover or get in touch to get some more individual workshop.</p><p>For target mode, we can only use resources which are target mode-ready, so let&rsquo;s keep this simple:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>  execute <span style=color:#ba2121>&#39;apt update &amp;&amp; apt upgrade --yes&#39;</span>
</span></span></code></pre></div><p>This is the most basic example to use and certainly not the highlight of this post - that&rsquo;s for Chef to remotely invoke a package upgrade.</p><p>If you want to use other resources to preprocess some templates and then remotely invoke them, I will show you a quick and dirty way of doing that until Chef implements some sort of <code>process_locally do ... end</code> syntax in a separate post.</p><h2 id=remote-execution>Remote Execution</h2><p>This one is pretty easy if you have SSH access configured to the remote machine and you can even find it in the Chef help:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chef-client -z -t 192.168.240.123 -r <span style=color:#ba2121>&#39;recipe[mycookbook::default]&#39;</span><span style=color:#ba2121>`</span>
</span></span></code></pre></div><p>So we are just invoking Chef in local target mode, without any server connections. If you set up everything correctly, you should see a regular Chef run, but with a remote target.</p><p>Keep in mind, that remote runs are slower due to latency and as Train starts a simple platform detection first, this will add a bit of lag as well.</p><h2 id=switching-backends>Switching Backends</h2><p>When I first played around with Target Mode, I suspected I could just put some <code>protocol=winrm</code> into the Credentials file or supply a URL like <code>-t winrm://somehost</code>. Turns out that is not (yet) the case. If you want to specify a protocol different from SSH, you seem to need configuration for that in your Chef config file (<code>~/.chef/client.rb</code>, <code>/etc/chef/client.rb</code> are popular places):</p><pre tabindex=0><code>target.protocol = &#39;winrm&#39;
</code></pre></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a>
<a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a>
<a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a>
<a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div></div></div></body></html>