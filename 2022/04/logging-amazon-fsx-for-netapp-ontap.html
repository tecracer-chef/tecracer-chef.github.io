<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Logging Amazon FSx for NetApp ONTAP | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/2022/04/logging-amazon-fsx-for-netapp-ontap.html><meta http-equiv=content-language content="en"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Logging Amazon FSx for NetApp ONTAP"><meta property="og:url" content="https://tecracer-chef.github.io/2022/04/logging-amazon-fsx-for-netapp-ontap.html"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/2022/04/logging-amazon-fsx-for-netapp-ontap.html"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(img/2022/04/alexandre-jaquetoni-6yelWDI3RE8-unsplash.png)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>22</span>
<span class=tm-article-date-month>Apr</span></div><h1 class=uk-article-title>Logging Amazon FSx for NetApp ONTAP</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><p>Recently, I spent a lot of time using the exciting new member of the FSx family. One detail made working with it a bit unpleasant, though - the lack of log files.</p><p>This post details how to create a custom integration into CloudWatch Logs and make ONTAP audit logs visible.</p><p><strong>Update 2022-04-28</strong>: Fixed configuration in the last step, actually applying the filter and adding a missing exclamation mark to the filter expression</p><p>Audit logs fulfill the same purpose on a storage cluster as CloudTail does on AWS: they record user activity with a clear focus on configuration changes.</p><h2 id=fsx-for-netapp-ontap-architecture>FSx for NetApp ONTAP Architecture</h2><p>While FSx makes consuming managed storage easy, it hides some of the underlying complexities. In this case, we get a Management endpoint IP and can create Storage Virtual Machines (SVMs) with their own endpoints.</p><p>SVMs provide multitenancy on your filesystems. In principle, you could create multiple SVMs and let every department manage its own storage. This component provides a clear management boundary between core infrastructure and tenants/departments.</p><p>But in addition, each cluster also has Admin SVMs which handle the underlying infrastructure. They are reachable via SSH or REST API to allow advanced configuration, debugging, and automation (Terraform, Ansible, Chef, etc.).</p><p>These Admin SVMs do provide a possibility to forward logs to a Syslog server, but as the nodes miss a default route, they can only reach their local subnet.</p><h2 id=aws-setup>AWS Setup</h2><p>We can provide local-subnet endpoints with AWS standard technology, though. Configuration of a Network Load Balancer in the subnets of FSx for NetApp ONTAP allows forwarding Syslog messages to some Syslog-Cloudwatch bridge instance.</p><p>The following steps will set this infrastructure up:</p><ul><li>Create an internal Application Load Balancer, placed in the two subnets of ONTAP (assuming a multi-AZ deployment)</li><li>Add a listener to 514/TCP (Syslog)</li><li>Create an EC2 Instance in any subnet</li><li>Allow the same 514/TCP incoming in its security group</li><li>Configure this instance as a listener to 514/TCP on your ALB</li></ul><h2 id=cluster-configuration>Cluster Configuration</h2><p>Now, you can SSH into your FSx Management Endpoint and configure log forwarding:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cluster log-forwarding create -destination &lt;NLB-IP1&gt; -port <span style=color:#666>514</span> -protocol tcp-unencrypted
</span></span><span style=display:flex><span>cluster log-forwarding create -destination &lt;NLB-IP2&gt; -port <span style=color:#666>514</span> -protocol tcp-unencrypted
</span></span></code></pre></div><p>We need both statements as we do not have cross-subnet routing capabilities and have to include the possibility of a failover of the cluster.</p><h2 id=ec2-configuration>EC2 Configuration</h2><p>Amazon Linux 2 already has RSyslog preinstalled, which can listen for TCP-based Syslog messages and write them to the local filesystem. Configuring this is straightforward.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt;/etc/rsyslog.d/network.conf <span style=color:#ba2121>&lt;&lt;CONFIG
</span></span></span><span style=display:flex><span><span style=color:#ba2121># Provides UDP syslog reception
</span></span></span><span style=display:flex><span><span style=color:#ba2121>$ModLoad imudp
</span></span></span><span style=display:flex><span><span style=color:#ba2121>$UDPServerRun 514
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121># Provides TCP syslog reception
</span></span></span><span style=display:flex><span><span style=color:#ba2121>$ModLoad imtcp
</span></span></span><span style=display:flex><span><span style=color:#ba2121>$InputTCPServerRun 514
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>$template RemoteLogs,&#34;/var/log/%HOSTNAME%/%PROGRAMNAME%.log&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>*.* ?RemoteLogs
</span></span></span><span style=display:flex><span><span style=color:#ba2121>&amp; ~
</span></span></span><span style=display:flex><span><span style=color:#ba2121>CONFIG</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl restart rsyslog
</span></span></code></pre></div><p>You should notice logs appearing in your log directory as soon as you log into the FSx Management Endpoint again via SSH.</p><p><img src=/img/2022/04/fsx-ontap-logging-local.png#center alt="Locally written logs"></p><h2 id=redirect-to-cloudwatch-logs>Redirect to CloudWatch Logs</h2><p>We could now pick up these logs with the CloudWatch unified agent, but we can make something even more potent with a third-party tool: Vector.</p><p>Vector is a free, modern observability tool that can ingest logs and metrics in almost every format. Then, it can filter and transform messages and forward them into many different backends.</p><p>As you might have guessed, it can ingest Syslog via network and write this to CloudWatch Logs. So let&rsquo;s set this up:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#408080;font-style:italic># Remove our previous test</span>
</span></span><span style=display:flex><span>rm /etc/rsyslog.d/network.conf
</span></span><span style=display:flex><span>systemctl restart rsyslog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Install Vector</span>
</span></span><span style=display:flex><span><span style=color:#19177c>VECTOR_VERSION</span><span style=color:#666>=</span><span style=color:#ba2121>&#34;0.21.0&#34;</span>
</span></span><span style=display:flex><span>yum install https://github.com/vectordotdev/vector/releases/download/v<span style=color:#b68;font-weight:700>${</span><span style=color:#19177c>VECTOR_VERSION</span><span style=color:#b68;font-weight:700>}</span>/vector-<span style=color:#b68;font-weight:700>${</span><span style=color:#19177c>VECTOR_VERSION</span><span style=color:#b68;font-weight:700>}</span>-1.x86_64.rpm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Test by writing Syslog messages to a local file</span>
</span></span><span style=display:flex><span>cat &gt; /etc/vector/vector.toml <span style=color:#ba2121>&lt;&lt;TOML
</span></span></span><span style=display:flex><span><span style=color:#ba2121>[sources.syslog_tcp]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>type = &#34;syslog&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>address = &#34;0.0.0.0:514&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>host_key = &#34;host&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>max_length = 102_400
</span></span></span><span style=display:flex><span><span style=color:#ba2121>mode = &#34;tcp&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>path = &#34;/var/run/vector.sock&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>receive_buffer_bytes = 65_536
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>[sinks.file]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>type = &#34;file&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>inputs = [ &#34;syslog_tcp&#34; ]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>compression = &#34;none&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>path = &#34;/tmp/vector-{{ hostname }}.log&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>  [sinks.file.encoding]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>  codec = &#34;text&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>TOML</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vector
</span></span></code></pre></div><p>Now, any audit logs coming from our FSx cluster will be written into a local file. And if you direct multiple clusters to this bridge instance, they will even arrive in different files.</p><p>We have to do two more things to make this practical: Allow our instance to write to CloudWatch Logs and modify <code>vector.toml</code> to output data correctly.</p><p>We will use a generic CloudWatch Logs IAM policy for demonstration purposes:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;Version&#34;</span>: <span style=color:#ba2121>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;Sid&#34;</span>: <span style=color:#ba2121>&#34;LimitToLogStream&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#ba2121>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#ba2121>&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ba2121>&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ba2121>&#34;logs:DescribeLogStreams&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ba2121>&#34;logs:DescribeLogGroups&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ba2121>&#34;logs:PutLogEvents&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;Resource&#34;</span>: <span style=color:#ba2121>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Attach an IAM role with this policy to your Syslog instance. Now, we need to update the configuration.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt; /etc/vector/vector.toml <span style=color:#ba2121>&lt;&lt;TOML
</span></span></span><span style=display:flex><span><span style=color:#ba2121>[sources.syslog_tcp]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>type = &#34;syslog&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>address = &#34;0.0.0.0:514&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>host_key = &#34;host&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>max_length = 102_400
</span></span></span><span style=display:flex><span><span style=color:#ba2121>mode = &#34;tcp&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>path = &#34;/var/run/vector.sock&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>receive_buffer_bytes = 65_536
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>[transforms.filter_fsx]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>type = &#34;filter&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>inputs = [ &#34;syslog_tcp&#34; ]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>condition = &#39;starts_with!(.hostname, &#34;FsxId&#34;)&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>[sinks.cloudwatch]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>type = &#34;aws_cloudwatch_logs&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>inputs = [ &#34;filter_fsx&#34; ]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>create_missing_group = true
</span></span></span><span style=display:flex><span><span style=color:#ba2121>create_missing_stream = true
</span></span></span><span style=display:flex><span><span style=color:#ba2121>group_name = &#34;fsx-for-netapp-ontap&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>compression = &#34;none&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>region = &#34;eu-central-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>stream_name = &#34;{{ host }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>  [sinks.cloudwatch.encoding]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>  codec = &#34;json&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>TOML</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl start vector
</span></span><span style=display:flex><span>systemctl <span style=color:green>enable</span> vector
</span></span></code></pre></div><p><img src=/img/2022/04/fsx-ontap-logging-cwl.png#center alt="CloudWatch logs"></p><p>Any log messages received via 514/TCP will be filtered for the correct hostname (starting with <code>FsxId</code>) and then written into our log group. As we enabled Vector for every system boot, this will now automatically forward logs - even in case of failover/failback events.</p><h2 id=summary>Summary</h2><p>With this post we have a solution to have basic audit logging of our FSx for NetApp ONTAP cluster until AWS integrated native logging functionality. We had to revisit ONTAP architecture and admin SVMs, find a routing problem in the standard AWS service setup and a way around it. In addition, we learned about Vector which brings a whole new array of logging capabilities.</p><p>I hope you found this post useful and it makes your debugging easier.</p></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a>
<a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a>
<a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a>
<a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright Â© 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div></div></div></body></html>