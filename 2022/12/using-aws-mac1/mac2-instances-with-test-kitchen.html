<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Using AWS mac1/mac2 Instances with Test Kitchen | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/2022/12/using-aws-mac1/mac2-instances-with-test-kitchen.html><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Using AWS mac1/mac2 Instances with Test Kitchen"><meta property="og:url" content="https://tecracer-chef.github.io/2022/12/using-aws-mac1/mac2-instances-with-test-kitchen.html"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/2022/12/using-aws-mac1/mac2-instances-with-test-kitchen.html"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(img/2022/12/pexels-wendy-wei-1656670-4-1.jpg)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>09</span>
<span class=tm-article-date-month>Dec</span></div><h1 class=uk-article-title>Using AWS mac1/mac2 Instances with Test Kitchen</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><p>Everybody who had to write software or work with configuration management for Apple knows of the problems to get access to test machines. AWS does offer both Intel- and M1-based Mac instances now and with <code>kitchen-ec2</code> v3.15.0 it is finally possible to use them in your existing workflow.</p><p>AWS announces the availability of Intel-based <code>mac1</code> instances in <a href=https://aws.amazon.com/about-aws/whats-new/2020/11/announcing-amazon-ec2-mac-instances-for-macos/>November 2020</a> and <code>mac2</code> M1 instances in <a href=https://aws.amazon.com/blogs/aws/new-amazon-ec2-m1-mac-instances/>July 2022</a>. These are based on Mac Minis in custom rack mounts, integrated into the AWS ecosystem</p><p><img src=/img/2022/12/mac-instances-hardware.png#center alt="Mac in AWS Rack"></p><p>Even in the AWS cloud, those are different: You can only use <code>mac1</code>/<code>mac2</code> on dedicated hosts (see my <a href>earlier post on kitchen-ec2 3.14</a>) and they have a minimum 24-hour allocation and billing period. Within this time, any try to deallocate a <code>mac1</code>/<code>mac2</code> host will fail with an error message.</p><p>In consequence, you should implement some sort of external lifecycle management to remove unused hosts automatically - either using AWS License Manager Host Resource Groups or using some custom tooling.</p><p><img src=/img/2022/12/mac-instances-hrg.png#center alt="Automated release of Dedicated Hosts"></p><h2 id=configuration-intel-based-mac1>Configuration: Intel-based <code>mac1</code></h2><p>With <code>kitchen-ec2</code> v3.15.0 it is pretty easy to use Apple-based instances.</p><p>The older Intel-based <code>mac1</code> instances are more expensive - in my preferred region <code>eu-west-1</code> they typically are around $25 per day (remember the 24-hour minimum billing here again).</p><p>They start fairly quickly and within about 5 minutes you can SSH into them or start your usual <code>kitchen converge</code> run.</p><p><img src=/img/2022/12/mac-instances-mac1.png#center alt="Provisioning mac1 with Test Kitchen"></p><p>At this point in time, you can develop and check your implementations. But there is a huge additional caveat: You might already be used to the short-lived instances of Test Kitchen, running rapid <code>kitchen create</code>/<code>kitchen destroy</code> actions.</p><p>This won&rsquo;t work on any AWS-based Apple instance.</p><p>As <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-mac-instances.html#mac-instance-stop>AWS details in its documentation</a>, any stop/termination of an instance on <code>mac1</code>/<code>mac2</code> hosts will automatically initiate the scrubbing workflow, which removes user data so new instances on the same hardware cannot access it. For Intel-based instances, this is documented to take <strong>roughly an hour</strong>. If you are particularly unlucky, this might even be longer if updated firmware is deployed automatically. For more info on the dedicated hosts lifecycle have a look at the <a href=https://aws.amazon.com/blogs/compute/understanding-the-lifecycle-of-amazon-ec2-dedicated-hosts/>detailed blog on the dedicated host lifecycle by AWS</a>.</p><p>For this duration, your Dedicated Host will stay in state <code>pending</code> and not be usable for your next tests.</p><p>Apart from this, adding a <code>mac1</code> platform to your Test Kitchen configuration is straightforward:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>platforms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>macos-12.5<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>instance_type</span>:<span style=color:#bbb> </span>mac1.metal<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>availability_zone</span>:<span style=color:#bbb> </span>eu-west-1a<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>tenancy</span>:<span style=color:#bbb> </span>host<span style=color:#bbb>
</span></span></span></code></pre></div><p>Notice, that the AZ needs to match one of any preallocated dedicated hosts (in that case, do not forget to add the <code>ManagedBy</code> tag with <code>Test Kitchen</code> as its value).</p><p>The <code>kitchen-ec2</code> driver will automatically search suitable official AMIs by the given version string (in this case, the AMI name will be searched with <code>amz-ec2-macos-12.5*</code>).</p><p>If you do not specify anything additionally, Intel-based AMIs will be the default.</p><h2 id=configuration-m1-based-mac2>Configuration: M1-based <code>mac2</code></h2><p>The newer variant of Mac instances is Apple M1-powered and cheaper. In my case, I pay around $17 per day in <code>eu-west-1</code>.</p><p>But for some reason, using <code>mac2</code> is much slower: Their start needs about 25 minutes and the scrubbing workflow is documented to be around two full hours. This duration is highly uncomfortable and limits your workflow despite the new Test Kitchen capabilities.</p><p><img src=/img/2022/12/mac-instances-console.png#center alt="Waiting for mac2 scrubbing"></p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>platforms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>macos-12.6-arm64<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>instance_type</span>:<span style=color:#bbb> </span>mac2.metal<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>availability_zone</span>:<span style=color:#bbb> </span>eu-west-1a<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>tenancy</span>:<span style=color:#bbb> </span>host<span style=color:#bbb>
</span></span></span></code></pre></div><p>It is particularly important to specify the architecture in the platform name (<code>-arm64</code>) which will influence the AMI search pattern to use the `arm64_mac&rsquo; architecture used by AWS internally.</p><h2 id=further-steps>Further Steps</h2><p>After you created your instance, you can work with it normally. Be it by using <code>kitchen login</code>, classical SSH, or switching over to SSM if you attached an IAM profile with the proper privileges.</p><p><img src=/img/2022/12/mac-instances-vnc.png#center alt="VNC Access"></p><p>The <code>aws-samples</code> GitHub repository contains a lot of information on what you can do next. You can read on their <a href=https://github.com/aws-samples/amazon-ec2-mac-getting-started/blob/main/steps/03_connect_and_enable.md>Mac Getting Started - Step 3</a> page how to enable VNC access, resize the virtual display or the root volume, etc.</p><h2 id=summary>Summary</h2><p>While it is now possible to use <code>mac1</code>/<code>mac2</code> with Test Kitchen, cost and start/stop durations make this barely usable. You are especially endangered to stack up massive bills if you forget to deallocate your unused Dedicated Hosts.</p><p>For the sake of sped-up delivery, let us hope that AWS finds a way to massively reduce the wait times on instance-level actions.</p></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a>
<a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a>
<a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a>
<a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright Â© 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div></div></div></body></html>