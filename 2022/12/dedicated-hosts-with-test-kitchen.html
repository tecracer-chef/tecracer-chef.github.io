<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Dedicated Hosts with Test Kitchen | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/2022/12/dedicated-hosts-with-test-kitchen.html><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Dedicated Hosts with Test Kitchen"><meta property="og:url" content="https://tecracer-chef.github.io/2022/12/dedicated-hosts-with-test-kitchen.html"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/2022/12/dedicated-hosts-with-test-kitchen.html"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(img/2022/12/pexels-brett-sayles-2881233-1920-4-1.png)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>02</span>
<span class=tm-article-date-month>Dec</span></div><h1 class=uk-article-title>Dedicated Hosts with Test Kitchen</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><p>Sometimes, you need to deploy software for tests with special licensing terms. To solve this, AWS offers Dedicated Instances and Dedicated Hosts - and now you can use them with <a href=https://kitchen.ci>Test Kitchen 3.14</a> in your developer workflows.</p><h2 id=why-dedicated-hosts>Why Dedicated Hosts</h2><p>While there are several reasons to use dedicated hosts, most are related to <a href=https://aws.amazon.com/ec2/dedicated-hosts/>licensing terms</a>. Some software vendors only issue licenses to be used on single-tenant systems. Others even require you to license all hosts where their software could run, not only those which do.</p><p>As a Dedicated Host (DH) is only available for your company and will never run instances from other customers, this fills those requirements. Licensing can be touchy, so please ask your license manager or software vendor if you have conditions like these.</p><p>Another reason is security-related: Theoretically, there could be bugs in the base hypervisor, which allow attackers to break out of an instance and then access other machines on the same hardware. While these cases are scarce, very sensitive data might be required to be run on dedicated machines.</p><h2 id=why-not-dedicated-instances>Why not Dedicated Instances</h2><p>Dedicated Instances can solve this issue. Their use cases are very similar to Dedicated Hosts while being much cheaper, but they might not fulfill vendor-specific licensing requirements.</p><p>It is easy to use them with Test Kitchen, as it is just a matter of defining <code>tenancy: dedicated</code> in your <code>kitchen.yml</code>, and it will work out of the box. Please look into the AWS pricing pages to get more information on the additional costs.</p><p>This setting has been available since <a href=https://github.com/test-kitchen/kitchen-ec2/blob/v1.3.0/CHANGELOG.md>version 1.3.0 of Test Kitchen</a></p><h2 id=dedicated-hosts-basics>Dedicated Hosts Basics</h2><p>In contrast to regular or Dedicated Instances, using Dedicated Hosts will require an additional step: Allocation of a host. This is a separate action in the web console or CLI/SDK, which needs <code>ec2:AllocateHosts</code> privileges.</p><p>You decide which type of instances you want (a DH will only support one specific family), which Availability Zone to pick, and if it is available for automatic use with corresponding instances.</p><p><img src=/img/2022/12/dedicatedhosts-ec2.png#center alt="EC2 Dedicated Hosts"></p><p>For our purposes in Test Kitchen, please remember to select auto-placement as it is not yet possible to address a specific task in the driver.</p><p>After the host gets provisioned within seconds, you can use it to place new instances on it until it is at capacity. At that point, you either have to stop other instances or need more hosts.</p><p>Remember to deallocate unnecessary hosts quickly to avoid paying for unused capacity. And notice that <code>t3</code> Dedicated Hosts are much more expensive in this case<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><h3 id=lifecycle>Lifecycle</h3><p>As you can see, the additional lifecycle management of DHs can be challenging.</p><p>You can manually allocate and deallocate hosts but risk having unused ones running too long without being noticed.</p><p>The <code>kitchen-ec2</code> driver can manage this overhead if you enable it. Both the <code>allocate_dedicated_hosts</code> and <code>deallocate_dedicated_hosts</code> settings are available to make granular changes, depending on if you work locally (set both to <code>true</code>), if you use this in a CI/CD system (likely allocate, but do deallocation on a schedule), or if you have some exceptional circumstances (like <code>mac</code> hosts)</p><p>On the AWS side, a little hidden gem is under the &ldquo;AWS License Manager&rdquo; service, where you can use the built-in Host Resource Groups feature.</p><p><img src=/img/2022/12/dedicatedhosts-licensemgr.png#center alt="License Manager"></p><p>This feature automatically allocates new hosts if additional capacity is needed or deallocates empty hosts.</p><p>But there is a caveat: It does not support all instance types but only a subset.</p><h2 id=using-it-with-test-kitchen>Using it with Test Kitchen</h2><p>To use this, you need to update the <code>driver</code> properties in your <code>kitchen.yml</code> as a top-level setting or as a more specific configuration under <code>platforms</code>.</p><p>The first property is <code>tenancy</code>, which usually is <code>default</code> - so it will allocate on-demand instances. You can set this to <code>dedicated</code>, which means Dedicated Instances, or to <code>host</code>.</p><p>If you use <code>host</code>, you should either use one of the external lifecycle management systems described above, or you need to set the <code>allocate_dedicated_hosts</code> setting to <code>true</code>.</p><p>Likewise, you might want to use the deallocation feature via <code>deallocate_dedicated_hosts</code> as <code>true</code>.</p><p>Notice that you need to specify the <code>availability-zone</code> attribute, or the AWS API will not know where to place the new host.</p><p>Finally, the following is a snippet for a working Dedicated Hosts configuration with Test Kitchen:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>allocate_dedicated_host</span>:<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>deallocate_dedicated_host</span>:<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>instances</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>ubuntu-20.04<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>availability-zone</span>:<span style=color:#bbb> </span>eu-west-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tenancy</span>:<span style=color:#bbb> </span>host<span style=color:#bbb>
</span></span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>See the <a href=https://aws.amazon.com/ec2/dedicated-hosts/pricing/#On-Demand_Pricing>AWS pricing page for dedicated hosts</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a>
<a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a>
<a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a>
<a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div></div></div></body></html>