<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Test-Kitchen on AWS (2022 edition) | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/2022/11/test-kitchen-on-aws-2022-edition.html><meta http-equiv=content-language content="en"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Test-Kitchen on AWS (2022 edition)"><meta property="og:url" content="https://tecracer-chef.github.io/2022/11/test-kitchen-on-aws-2022-edition.html"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/2022/11/test-kitchen-on-aws-2022-edition.html"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(img/2022/11/sd15-563811029.png)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>02</span>
<span class=tm-article-date-month>Nov</span></div><h1 class=uk-article-title>Test-Kitchen on AWS (2022 edition)</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><p>Test-Kitchen is a tool to manage your test machine lifecycle, similar to HashiCorp Vagrant. While it has been developed with Chef in mind, it can be used with any development tool to test on new machines every time you change your code.</p><p>As this tool continues to evolve and many examples are outdated, today I will give you some small snippets to reuse and get going quickly.</p><h2 id=installation>Installation</h2><p>There are two ways to install Test-Kitchen:</p><ol><li>If you already have Ruby installed: <code>gem install test-kitchen kitchen-ec2</code></li><li>Use the bundled installer with <a href=https://www.chef.io/downloads/tools/workstation>Chef Workstation</a></li></ol><p>You can find more details in the <a href=https://kitchen.ci/docs/getting-started/introduction/>official documentation</a>. This article will focus on how to use it with AWS.</p><h2 id=minimal-config>Minimal Config</h2><p>You will find much-outdated information if you search the Internet about using Test-Kitchen with AWS. For example, you are often asked to create IAM Profiles, SSH Keys, or Security Groups.</p><ul><li>IAM Profiles are not necessary unless you specifically want to use private S3 buckets etc</li><li>SSH Keys will be automatically created and removed (your AWS user will, of course, need the corresponding privileges)</li><li>Security Groups will also be automatically managed</li><li>You do not need to find the <code>subnet-xxxxxxxx</code> ID to deploy your instance anymore, but you can use tagging instead</li></ul><p>An essential addition is to switch to Instance Metadata Services v2 (IMDSv2). IMDS is responsible for providing access to the meta information of your EC2 instance, which could leak sensitive data with the older version 1. With the new IMDSv2, it is much harder to exploit it.</p><p>The following <code>kitchen.yml</code> file uses all these features:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>ec2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>subnet_filter</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tag</span>:<span style=color:#bbb> </span><span style=color:#ba2121>&#39;Name&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#ba2121>&#39;*public*&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata_options</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>http_tokens</span>:<span style=color:#bbb> </span>required<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>http_put_response_hop_limit</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>instance_metadata_tags</span>:<span style=color:#bbb> </span>enabled<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>instance_type</span>:<span style=color:#bbb> </span>t3a.medium<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>associate_public_ip</span>:<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>interface</span>:<span style=color:#bbb> </span>public<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>skip_cost_warning</span>:<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tags</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>CreatedBy</span>:<span style=color:#bbb> </span>test-kitchen<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>platforms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>amazon2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>amazon2-arm64<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>instance_type</span>:<span style=color:#bbb> </span>t4g.nano<span style=color:#bbb>
</span></span></span></code></pre></div><p>The <code>subnet_filter</code> assumes that you have Subnets with the <code>Name</code> tag, including the term <code>public</code>. Careful: it is not possible to specify a VPC so take care that you pick the right one if your AWS account includes multiple VPCs. Otherwise, TK will pick the first one returned - which might cause some problems.</p><p>With our <code>metadata_options</code>, we configure IMDS v2. The hop count of <code>1</code> should work for your applications; it usually only needs changing if you run containers. With the addition of <code>instance_metadata_tags</code> we can also use EC2 tags as metadata. If you use Chef, these will be available under <code>node['ec2']['tags_instance_MyTagName']</code>.</p><p>Notice under <code>platforms</code> that you can add a specific architecture like ARM64 for Graviton, which is possible since <a href=https://github.com/test-kitchen/kitchen-ec2/commit/dba6a96596632afa44b88f7fc9615aba7468c7f6>version 2.3.3</a></p><p>This architecture will then create EC2 instances in your public subnet, assign a temporary Security Group and let you SSH/WinRM into them for development.</p><h2 id=avoiding-sshwinrm>Avoiding SSH/WinRM</h2><p>Newer AWS architectures recommend avoiding public instances and SSH, instead relying on AWS SystemManager (AWS SSM). This service works with a pre-installed agent on the most common AMIs and offers a lot of functionality, such as command execution, inventory, patching, and much more.</p><p>You must explicitly attach the corresponding permissions to your instance to enable it. If you want to do this via code, the following Terraform snippet creates a role and an EC2 profile to use:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:green;font-weight:700>resource</span> <span style=color:#ba2121>&#34;aws_iam_role&#34; &#34;testkitchen&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#666>=</span> <span style=color:#ba2121>&#34;test-kitchen&#34;</span>
</span></span><span style=display:flex><span>  assume_role_policy  <span style=color:#666>=</span> <span style=color:green;font-weight:700>data</span>.<span style=color:green;font-weight:700>aws_iam_policy_document</span>.<span style=color:green;font-weight:700>instance_assume_role_policy</span>.<span style=color:green;font-weight:700>json</span>
</span></span><span style=display:flex><span>  managed_policy_arns <span style=color:#666>=</span> [<span style=color:#ba2121>&#34;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>inline_policy</span> {}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>resource</span> <span style=color:#ba2121>&#34;aws_iam_instance_profile&#34; &#34;testkitchen&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#666>=</span> <span style=color:#ba2121>&#34;test-kitchen&#34;</span>
</span></span><span style=display:flex><span>  role <span style=color:#666>=</span> <span style=color:green;font-weight:700>aws_iam_role</span>.<span style=color:green;font-weight:700>testkitchen</span>.<span style=color:green;font-weight:700>name</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Trying not to use classical remote access creates a problem with Test-Kitchen: It only supports SSH and WinRM for this purpose. But other transports are available as plugins to extend support to other protocols.</p><p>On the other hand, similar functionality exists for other tools like InSpec, Chef Target Mode, or <code>knife bootstrap</code>: the <a href=https://github.com/inspec/train>Train transport framework</a>. It has a rich ecosystem of standard and more exotic remote access protocols, including AWS SSM.</p><p>By combining two tools, we can achieve our goal of SSH/WinRM-less access to our development machines:</p><ol><li><a href=https://github.com/tecracer-chef/kitchen-transport-train/><code>kitchen-transport-train</code></a> creates the necessary glue to use TK with Train</li><li><a href=https://github.com/tecracer-chef/train-awsssm><code>train-awsssm</code></a> allows executing commands (RunCommands) via AWS SSM</li></ol><p>You can install both with <code>chef gem install kitchen-transport-train train-awsssm</code> (if you use Chef Workstation) or <code>gem install kitchen-transport-train train-awsssm</code> (if you use plain Ruby).</p><p>As this technique uses non-interactive execution, this will sadly make your <code>kitchen login</code> commands unusable. But you can use AWS&rsquo; built-in <code>aws ssm start-session --target i-123456789012</code> commands instead.</p><p>Our alternative <code>kitchen.yml</code> file now looks like this:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>ec2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>subnet_filter</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tag</span>:<span style=color:#bbb> </span><span style=color:#ba2121>&#39;Name&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#ba2121>&#39;*private*&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata_options</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>http_tokens</span>:<span style=color:#bbb> </span>required<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>http_put_response_hop_limit</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>instance_metadata_tags</span>:<span style=color:#bbb> </span>enabled<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>instance_type</span>:<span style=color:#bbb> </span>t3a.medium<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>iam_profile_name</span>:<span style=color:#bbb> </span>test-kitchen<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>skip_cost_warning</span>:<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tags</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>CreatedBy</span>:<span style=color:#bbb> </span>test-kitchen<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>transport</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>train<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>backend</span>:<span style=color:#bbb> </span>awsssm<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>execution_timeout</span>:<span style=color:#bbb> </span><span style=color:#666>600</span><span style=color:#bbb> </span><span style=color:#408080;font-style:italic># non-session based, so increase timeout per command</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>platforms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>amazon2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>amazon2-arm64<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>driver</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>instance_type</span>:<span style=color:#bbb> </span>t4g.nano<span style=color:#bbb>
</span></span></span></code></pre></div><p>We changed our <code>subnet_filter</code> to use subnets marked as private and skipped <code>associate_public_ip</code> and <code>interface</code>.</p><p>To enable SSM access, we have to specify the <code>iam_profile_name</code> we created with the needed permissions.</p><p>Our new <code>transport</code> section configures TK to use <code>train</code> and <code>awsssm</code> for execution. As this is not session-based, but non-interactive, we need to increase the <code>execution_timeout</code> to the maximum estimated Chef run duration.</p><p>Support for the quicker AWS SSM Session Manager is currently in development. Still, it will need a while as this uses a <a href=https://github.com/bertrandmartel/aws-ssm-session/blob/master/src/ssm.js>custom AWS binary protocol</a>, which is a bit light on the debugging information.</p><h2 id=summary>Summary</h2><p>Now you know how to use AWS much easier with Test-Kitchen. The solutions should eliminate the need for a personalized <code>kitchen.local.yml</code> or even a global configuration. Only tag a subnet, and this will work.</p><p>I would be happy about feedback regarding the non-SSH/WinRM alternative, as I wrote both plugins. If you encounter problems or have feature requests, open an issue on the corresponding repositories.</p></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=125 width=125></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_self class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a>
<a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a>
<a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a>
<a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div></div></div></body></html>