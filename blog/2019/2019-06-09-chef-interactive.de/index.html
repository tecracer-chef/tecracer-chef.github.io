<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Chef Interactive | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/blog/2019/2019-06-09-chef-interactive.de/><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="Chef Interactive"><meta property="og:url" content="https://tecracer-chef.github.io/blog/2019/2019-06-09-chef-interactive.de/"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/blog/2019/2019-06-09-chef-interactive.de/"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script><script src=https://tecracer-chef.github.io/js/uikit.min.js></script><script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/>Blog</a></li><li><a href=/authors>Authors</a></li><li><a href=/github/github-prs.html>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(/img/2019/06/sergi-kabrera-2xU7rYxsTiM-unsplash.jpg)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>07</span>
<span class=tm-article-date-month>Jun</span></div><h1 class=uk-article-title>Chef Interactive</h1><p class=uk-article-meta>Written by
<a target=_self title="Thomas Heinen's Author Profile SINGLE.HTML" href=/authors/thomas-heinen data-original-title="Author's Profile">Thomas Heinen</a></p><div class=uk-margin><p>Es ist vermutlich bekannt, dass <a href=https://chef.io>Chef</a> ein Tool für die automatische Provisionierung und Konfiguration von Systemen ist. Sobald man also ein Problem hat, dass diese beiden Bereiche verlässt, werden Internetposts und Supportanfragen jeder Art wahrscheinlich in eine von zwei Antworten münden: „Das ist nicht möglich“ oder „So macht man das aber nicht“.</p><p>Aber – was wenn man einen echten, exotischen Anwendungsfall hat. Und das möglicherweise nur als Übergangslösung?</p><h1 id=use-cases>Use Cases</h1><p>Für den Inhalt dieses Posts sind uns bisher zwei Use Cases untergekommen: Die Modernisierung eines Provisionierungsworkflows oder der Einsatz von Tools, die nur interaktiv installiert werden können.</p><p>Beispiel hier wäre eine Firma, in der IT Systeme als Teil einer größeren Lösung vorinstalliert werden. Diese Systeme sind also nur ein kleiner Teil des Produktes und wahrscheinlich sogar einer, der als nicht-zentral für das Endresultat gesehen wird. Insbesondere dann, wenn dieser Workflow ausgelagert ist zu einem Dienstleister, müssen einige Bedingungen beachtet werden bis fortgeschrittene Lösungen ausgerollt werden können. Natürlich würde ein „Big Bang“ besser sein und direkt alles auf die neuen Tools optimieren. Aber wie oft hat dieser Ansatz in der Vergangenheit wirklich funktioniert?</p><p>In unserem nicht-ganz-so-hypothetischen Fall werden wir uns einen Workflow vorstellen, in dem Mitarbeiter daran gewohnt sind, eine frische Windowsinstanz zu starten und dann diverse Aufgaben zur Einrichtung durchzuführen. Viele dieser Aufgaben können wir schon mit Chef-basierten Lösungen ersetzen. Aber wie handhaben wir, wenn Server mit der falschen Anzahl von Festplatten geliefert werden? Oder wenn wir Konfigurationsabweichungen haben, die nur manuell gelöst werden können? Normalerweise sollten diese Fälle in der Fertigung nicht auftreten – jeder, der die Lean Bewegung verfolgt hat, kennt vermutlich das <a href=https://www.lean.org/lexicon/jidoka>Jidoka-Prinzip</a>. Aber gehen wir davon aus, dass wir dieses Thema nicht beeinflussen können und einen Umweg brauchen.</p><p>Einige dieser Punkte klingen vielleicht bekannt. Setups die aus unverständlichen Gründen keine automatisierte Installation beherrschen. Keine Parameter für den Installer – oder schlimmer, ein Popupfenster in das Aktivierungsschlüssel eingegeben werden müssen. Eine pragmatische Lösung ist es, Tools wie
<a href=https://www.autoitscript.com/site/autoit>AutoIt</a> oder <a href=https://www.autohotkey.com>AutoHotkey</a> zu nutzen um auf diese Events zu warten und dann Tastatureingaben/Mausklicks zu simulieren.</p><p>Das Kernproblem ist dann, dass Chef als Hintergrundprozess arbeitet und keinen UI-Zugriff hat. Nicht einmal eine simulierte UI – damit kommt auch AutoIt nicht klar.</p><h1 id=schritt-1-interaktiv-werden>Schritt 1: Interaktiv werden</h1><p>Zwei Ansätze sind hier möglich: der eine mit einem Tool aus der Sysinternals Suite von Microsoft mit Namen „psexec“ und einer, der rein mit Windows-Bordmitteln funktioniert. Beides erfordert eine interaktive Windows-Session, also ist dies unsere erste Aufgabe.</p><p>Windowssysteme haben die Möglichkeit, einen Benutzer automatisch beim Systemstart anzumelden. Ganz offensichtlich ist dies sicherheitstechnisch bedenklich, in unserem Use Case sind wir aber in einem einmaligen Workflow – wir können diese temporäre Sicherheitslücke also später wieder entfernen.</p><p>Aktuell besitzt Chef keine Ressource, um Autologin zu aktivieren oder deaktivieren. Aber wir können uns eine simple Custom Resource schreiben die mit der <a href=https:%5Cdocs.chef.io%5Cresource_registry_key.html>registry_key resource</a> die passenden Werte setzt:</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>resource_name <span style=color:#19177c>:autologin</span>
 
property <span style=color:#19177c>:user</span>, <span style=color:green>String</span>, <span style=color:#19177c>name_property</span>: <span style=color:green>true</span>
property <span style=color:#19177c>:password</span>, <span style=color:green>String</span>
 
default_action <span style=color:#19177c>:enable</span>
 
action <span style=color:#19177c>:enable</span> <span style=color:green;font-weight:700>do</span>
  registry_key <span style=color:#ba2121>&#39;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#39;</span> <span style=color:green;font-weight:700>do</span>
    values <span style=color:#666>[</span>
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultUserName&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: new_resource<span style=color:#666>.</span>user },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultPassword&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: new_resource<span style=color:#666>.</span>password },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;AutoAdminLogon&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:dword</span>, <span style=color:#19177c>data</span>: <span style=color:#666>1</span> },
    <span style=color:#666>]</span>
    sensitive <span style=color:green>true</span>
    action <span style=color:#19177c>:create</span>
    notifies <span style=color:#19177c>:reboot_now</span>, <span style=color:#ba2121>&#39;reboot[now]&#39;</span>, <span style=color:#19177c>:immediate</span>
  <span style=color:green;font-weight:700>end</span>
 
  reboot <span style=color:#ba2121>&#39;now&#39;</span> <span style=color:green;font-weight:700>do</span>
    action <span style=color:#19177c>:nothing</span>
  <span style=color:green;font-weight:700>end</span>
<span style=color:green;font-weight:700>end</span>
 
action <span style=color:#19177c>:disable</span> <span style=color:green;font-weight:700>do</span>
  registry_key <span style=color:#ba2121>&#39;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#39;</span> <span style=color:green;font-weight:700>do</span>
    values <span style=color:#666>[</span>
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultUserName&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: <span style=color:#ba2121>&#39;&#39;</span> },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;DefaultPassword&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:string</span>, <span style=color:#19177c>data</span>: <span style=color:#ba2121>&#39;&#39;</span> },
      { <span style=color:green>name</span>: <span style=color:#ba2121>&#39;AutoAdminLogon&#39;</span>, <span style=color:#19177c>type</span>: <span style=color:#19177c>:dword</span>, <span style=color:#19177c>data</span>: <span style=color:#666>0</span> },
    <span style=color:#666>]</span>
    action <span style=color:#19177c>:create</span>
  <span style=color:green;font-weight:700>end</span>
<span style=color:green;font-weight:700>end</span>
</code></pre></div><p>Wie man sieht, enthält diese Lösung einen bedingten Reboot und wir brauchen tatsächlich einen Neustart zu diesem Zeitpunkt. Darüber hinaus: Benutzer und Passwort stehen im Klartext in der Registry! Leider gibt es aber keinen alternativen Weg, ich bin für Kommentare natürlich dankbar.</p><p>Bei der Verwendung dieser Ressource müssen zwei Punkte bedacht werden:</p><ul><li>autologin muss nach dem Abschluss wieder deaktiviert werden (hier ist allerdings kein Reboot notwendig)</li><li>dieser Task wird bei jeder Aktivierung einen Neustart bewirken, wir brauchen also einen Guard um die Schritte nur einmal zu starten (z.B. ein Registry Key ob das Programm schon installiert ist)</li></ul><h1 id=schritt-2-arbeitsplanung>Schritt 2: Arbeitsplanung</h1><p>Wie können wir jetzt eine Ressource ausführen, nachdem der Server gestartet ist? Einen Hinweis gibt der Titel – wir werden nämlich den Windows Task Scheduler nutzen, der eine Konfiguration bietet die uns hilft:</p><ul><li>den Zeitpunkt des Tasks als „on logon” definieren</li><li>die Eigenschaft „Start when a user is logged on” (dafür brauchten wir die Autologin Ressource)</li><li>Nutzer/Passwort für den Task</li></ul><p>Da der Task in der gleichen Session starten soll, die per Autologin eingeloggt wurde, können wir uns die Zugangsdaten direkt aus der Registry besorgen. Keine Duplikation und sogar ein Vorteil von der Speicherung in Klartext. Die Chef <a href=https:%5Cdocs.chef.io%5Cresource_windows_task.html>windows_task
resource</a> macht die Einrichtung einfach.</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>resource_name <span style=color:#19177c>:execute_interactive</span>
 
property <span style=color:#19177c>:command</span>, <span style=color:green>String</span>, <span style=color:#19177c>name_property</span>: <span style=color:green>true</span>
 
default_action <span style=color:#19177c>:enable</span>
 
action <span style=color:#19177c>:enable</span> <span style=color:green;font-weight:700>do</span>
  <span style=color:green>require</span> <span style=color:#ba2121>&#39;securerandom&#39;</span>

  <span style=color:#408080;font-style:italic># Extract from autologin settings</span>
  autologin <span style=color:#666>=</span> registry_get_values(<span style=color:#ba2121>&#39;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#39;</span>)
  user_auto <span style=color:#666>=</span> autologin<span style=color:#666>.</span>select { <span style=color:#666>|</span>data<span style=color:#666>|</span> data<span style=color:#666>[</span><span style=color:#19177c>:name</span><span style=color:#666>]</span> <span style=color:#666>==</span> <span style=color:#ba2121>&#39;DefaultUserName&#39;</span> }<span style=color:#666>.</span>first<span style=color:#666>[</span><span style=color:#19177c>:data</span><span style=color:#666>]</span>
  password_auto <span style=color:#666>=</span> autologin<span style=color:#666>.</span>select { <span style=color:#666>|</span>data<span style=color:#666>|</span> data<span style=color:#666>[</span><span style=color:#19177c>:name</span><span style=color:#666>]</span> <span style=color:#666>==</span> <span style=color:#ba2121>&#39;DefaultPassword&#39;</span> }<span style=color:#666>.</span>first<span style=color:#666>[</span><span style=color:#19177c>:data</span><span style=color:#666>]</span>
  taskname <span style=color:#666>=</span> <span style=color:green>format</span>(<span style=color:#ba2121>&#39;execute-interactive-%s&#39;</span>, <span style=color:#800>SecureRandom</span><span style=color:#666>.</span>hex(<span style=color:#666>4</span>))
 
  windows_task <span style=color:#ba2121>&#39;Create task &#39;</span> <span style=color:#666>+</span> taskname <span style=color:green;font-weight:700>do</span>
    action <span style=color:#666>[</span><span style=color:#19177c>:create</span>, <span style=color:#19177c>:run</span><span style=color:#666>]</span>
    task_name taskname
    command new_resource<span style=color:#666>.</span>command
 
    interactive_enabled <span style=color:green>true</span>
    user user_auto
    password password_auto
    sensitive <span style=color:green>true</span>
 
    run_level <span style=color:#19177c>:highest</span>
    frequency <span style=color:#19177c>:once</span>
    start_time <span style=color:#800>Time</span><span style=color:#666>.</span>now<span style=color:#666>.</span>strftime(<span style=color:#ba2121>&#39;%H:%M&#39;</span>)
  <span style=color:green;font-weight:700>end</span>
 
  powershell_script <span style=color:#ba2121>&#39;Wait for completion of &#39;</span> <span style=color:#666>+</span> taskname <span style=color:green;font-weight:700>do</span>
    action <span style=color:#19177c>:run</span>
    code <span style=color:#666>&lt;&lt;~</span><span style=color:#800>PS1</span>
      <span style=color:#800>Do</span> {
        <span style=color:#800>Start</span><span style=color:#666>-</span><span style=color:#800>Sleep</span> <span style=color:#666>-</span><span style=color:#800>Seconds</span> <span style=color:#666>1</span>
      } <span style=color:green;font-weight:700>while</span> ((<span style=color:#800>Get</span><span style=color:#666>-</span><span style=color:#800>ScheduledTaskInfo</span> <span style=color:#666>-</span><span style=color:#800>TaskName</span> <span style=color:#408080;font-style:italic>#{taskname}).LastTaskResult -ge 0x41301)</span>
    <span style=color:#800>PS1</span>
  <span style=color:green;font-weight:700>end</span>
 
  windows_task <span style=color:#ba2121>&#39;Remove task &#39;</span> <span style=color:#666>+</span> taskname <span style=color:green;font-weight:700>do</span>
    task_name taskname
    action <span style=color:#19177c>:delete</span>
  <span style=color:green;font-weight:700>end</span>
<span style=color:green;font-weight:700>end</span>
</code></pre></div><p>Diese Lösung ist natürlich ein absolutes Minimum und eine produktive Implementation hat noch ein paar Zusatzpunkte. Aber es funktioniert! Für alle fortgeschrittenen Chef User sei dazugesagt, dass diese Lösung immer konvergierte Ressourcen produziert – falls darauf also in einer Pipeline getestet wird, um „idempotenten“ Code zu erzwingen, sollte das berücksichtigt werden.</p><p>Falls AutoIt/AutoHotkey genutzt wird, empfehle ich eine Custom Ressource in Chef die nur den Code des Scripts annimmt. Damit enthält das Chef-Recipe alle Punkte der Infrastruktur und die Lösung ist nicht auf mehrere Dateien verteilt. Für einen fortgeschrittenen Chef-Practitioner sollte das kein Problem sein.</p><h2 id=alternative-psexec>Alternative: PSExec</h2><p>Der zweite Weg funktioniert mit der Sysinternals Suite von Microsoft, die ein <a href=https:%5Cdocs.microsoft.com%5Cen-us%5Csysinternals%5Cdownloads%5Cpsexec>Tool zur Taskausführung</a> enthält. PSExec hat Parameter für interaktiven Start und auch die Nutzung des System Accounts. Falls also aus diversen Gründen die Windows Task-Lösung nicht gewünscht ist und die Nutzung externer Ressourcen akzeptabel ist, geht auch diese Variante. Auch hier wird allerdings die Autologin Ressource notwendig, nur die execute_interactive Custom Resource muss anders geschrieben werden.</p><h1 id=zusammenfassung>Zusammenfassung</h1><p>Auch wenn diverse Leute (meist zu recht) davon abraten, Programme mit Chef interaktiv zu starten – es ist möglich. Die Anwendung dieser Ideen sollte aber immer ein letztes Mittel oder eine Übergangslösung sein. In unserem Beispiel der Fertigung wäre es ohnehin besser, wenn immer gleiche Server geliefert würden oder unterliegende Schritte angepasst werden. Die Virtualisierung von Servern zusammen mit automatischem Deployment von VMware ESX wäre hier wesentlich besser.</p></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person><div class="media author-box"><div class=media-figure><img alt="Author Image" src=/authors/theinen.png class="avatar avatar-100 photo" height=90 width=90></div><div class=media-body><h2><a href=/authors/thomas-heinen>Thomas Heinen</a></h2><p>Thomas is a Cloud Consultant and Trainer at tecRacer Consulting with a focus on Chef, AWS, DevOps and Security.</p><div class=author-icons><a target=_new class=author-website title="Thomas Heinen's Author Profile" href=/authors/thomas-heinen.html data-original-title="Author's Profile"><i class="fas fa-id-card"></i></a><a target=_new class=author-xing title="Thomas Heinen on Xing" href=https://xing.com/profile/Thomas_Heinen4 data-original-title=Xing><i class="fab fa-xing"></i></a><a target=_new class=author-linkedin title="Thomas Heinen on LinkedIn" href=https://linkedin.com/in/thomas-heinen data-original-title=LinkdIn><i class="fab fa-linkedin"></i></a><a target=_new class=author-github title="Thomas Heinen on GitHub" href=https://github.com/tecracer-theinen data-original-title=Github><i class="fab fa-github"></i></a></div></div></div></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a><img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/>Blog</a></li><li><a href=/authors>Authors</a></li><li><a href=/github/github-prs.html>Pull Requests</a></li></ul></div></div></div></body></html>