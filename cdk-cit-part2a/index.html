<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>CDK Infrastructure Testing - Part 2a - Implement Unit, Integration and Application Test for CDK Infrastructure and an EC2 Web Server Application | tecRacer Chef</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://tecracer-chef.github.io/cdk-cit-part2a/><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="tecRacer Chef"><meta property="og:title" content="CDK Infrastructure Testing - Part 2a - Implement Unit, Integration and Application Test for CDK Infrastructure and an EC2 Web Server Application"><meta property="og:url" content="https://tecracer-chef.github.io/cdk-cit-part2a/"><meta property="og:image" content="https://tecracer-chef.github.io/images/"><meta name=twitter:title content="tecRacer Chef"><meta name=twitter:url content="https://tecracer-chef.github.io/cdk-cit-part2a/"><meta name=twitter:image content="https://tecracer-chef.github.io/images/"><meta name=twitter:card content><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://tecracer-chef.github.io/css/theme.css rel=stylesheet><script src=https://tecracer-chef.github.io/js/jquery.min.js></script>
<script src=https://tecracer-chef.github.io/js/uikit.min.js></script>
<script src=https://tecracer-chef.github.io/js/fa-all.js></script></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/tecracer-chef class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://twitter.com/tecracer class="uk-icon-hover uk-icon-small uk-icon-twitter" target=_blank></a></li><li><a href=https://www.xing.com/companies/tecracergmbh%26co.kg class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/company/tecracer-group/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/tecRacer class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><div class="tm-article-featured-image uk-cover-background" style=background-image:url(img/2021/06/three.png)></div><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>20</span>
<span class=tm-article-date-month>Jun</span></div><h1 class=uk-article-title>CDK Infrastructure Testing - Part 2a - Implement Unit, Integration and Application Test for CDK Infrastructure and an EC2 Web Server Application</h1><p class=uk-article-meta>Written by
Gernot Glawe</p><div class=uk-margin><p>With CDK you create Infrastructure as Code - IaC. You can automate the test for the IaC code.
The three test tastes -Unit, Integration and Application- should work closely together. Here I show you how. It is like the three steps of coffee tasting: 1 smell, 2 Taste, 3 Feel.</p><p>You can start immediately with the GO implementation or achieve the same effect in another CDK-supported language such as TypeScript or Python by following the steps described. The cit GO integration and application tests are directly applicable to all CDK templates, no matter which programming language is used.</p><p>With a few lines of code, you got tests for the stack level, the physical resource level and the application. Let`s apply that to a CDK generated EC2 Load Balancer App.</p><h2 id=from-unit-test-to-application-test-with-a-load-balancer-ec2-app>From Unit test to application test with a Load Balancer EC2 App</h2><p><img src=/img/2021/06/mapping.png alt=Mapping></p><p>We will go through three test types in this post</p><ol><li>The Unit test</li><li>The physical resource test called cit - CDK Infrastructure Testing</li><li>Application Test</li></ol><h3 id=overview>Overview</h3><p><strong>Unit Test</strong>:
The generated CloudFormation (Cfn) is tested. Usually, you can rely on the fact that e.g. the SNS Construct generates an SNS Resource, but&mldr;
When you use some programming logic inside the Construct, you can not be 100% sure that the right AWS resources are generated. This is what Unit testing is made for.</p><p><strong>Integration Test</strong>:
Resource creation is tested. Sometimes on Monday, I ask myself the question &ldquo;did I <em>really</em> deploy that last Friday?&rdquo; - this happens when you run out of coffee.
So the next level is to test whether the resource in the Construct really is created. To get traceability I want to use the given Construct ID to access the physical resource. Traceability means that you know which Resource is created by which Construct.</p><p><strong>Application Test</strong>:
The functionality of the application is tested. With an AWS application bundled with infrastructure, a new version of your app does not only consist of the software itself but also the changes in the infrastructure. So it makes sense to test the responses from the application to certain requests.</p><p>Let&rsquo;s walk through the steps. We use <code>go/alb_ec2</code> from the repository <code>https://github.com/tecracer/cdk-templates</code>. You will find the same CDK template in <code>typescript/alb_ec2</code>. Still, somebody has to code the python example&mldr;</p><p><img src=/img/2021/06/alb-ec2.png alt="Load Balancer">
CDK generated Web Server.</p><h3 id=1-smell-unit-test---template-creation><strong>1 Smell: Unit Test - Template creation</strong></h3><p>As discussed in <a href=/2021/05/cit-build-cdk-infrastructure-testing-part-1-terratest-and-the-integrated-integration.html>Part 1</a>, the standard <em>Unit Tests</em> checks the CDK generated CloudFormation template.</p><p>We create an Application Load Balancer with the <strong>ConstructID</strong> <code>LB</code></p><p>This name should be meaningful to you. I like names short and sweet, so &ldquo;LB&rdquo;.
<strong>This id will be used for all test types.</strong> You do not need to create Systems Manager Parameters or CloudFormation Exports like discussed in part 1, just use the Construct ID.</p><p>This is the Load Balancing Construct in GO CDK:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>lb <span style=color:#666>:=</span> elasticloadbalancingv2.<span style=color:#00f>NewApplicationLoadBalancer</span>(stack, aws.<span style=color:#00f>String</span>(<span style=color:#ba2121>&#34;LB&#34;</span>),
</span></span><span style=display:flex><span>  <span style=color:#666>&amp;</span>elasticloadbalancingv2.ApplicationLoadBalancerProps{
</span></span><span style=display:flex><span>    Vpc:              myVpc,
</span></span><span style=display:flex><span>    InternetFacing:   aws.<span style=color:#00f>Bool</span>(<span style=color:green;font-weight:700>true</span>),
</span></span><span style=display:flex><span>    LoadBalancerName: aws.<span style=color:#00f>String</span>(<span style=color:#ba2121>&#34;ALBGODEMO&#34;</span>),
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>While it is a string <code>'LB'</code> in TypeScript, GO uses String pointers for efficiency. <code>aws.String("LB")</code> creates a string pointer.</p><p>This is the Load Balancing Construct in TypeScript CDK:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:green;font-weight:700>const</span> lb <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> ApplicationLoadBalancer(<span style=color:green;font-weight:700>this</span>, <span style=color:#ba2121>&#39;LB&#39;</span>, {
</span></span><span style=display:flex><span>    vpc: <span style=color:#b00040>albVpc</span>,
</span></span><span style=display:flex><span>    internetFacing: <span style=color:#b00040>true</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  });
</span></span></code></pre></div><p>This is the Load Balancing Construct in Python CDK:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>lb <span style=color:#666>=</span> elbv2<span style=color:#666>.</span>ApplicationLoadBalancer(self, <span style=color:#ba2121>&#34;LB&#34;</span>,
</span></span><span style=display:flex><span>        vpc<span style=color:#666>=</span>vpc,
</span></span><span style=display:flex><span>        internet_facing<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><p>The <em>second</em> parameter is the Construct ID.</p><p>With the Construct defined, we can call <code>cdk synth</code>. This <em>synth</em>esizes the CloudFormation template in the directory <code>cdk.out</code>.</p><p>Tipp: Use <code>npx cdk@v2.0.0-rc.8</code> instead of <code>cdk</code> which will call the TypeScript transpiler , so you do no need <code>npm build</code> before.</p><p>In the CloudFormation template <code>cdk.out/AlbInstStack.template.json</code> this is the generated code for the Load Balancer:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#ba2121>&#34;LB8A12904C&#34;</span><span>:</span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;Type&#34;</span>: <span style=color:#ba2121>&#34;AWS::ElasticLoadBalancingV2::LoadBalancer&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;Properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;LoadBalancerAttributes&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;Key&#34;</span>: <span style=color:#ba2121>&#34;deletion_protection.enabled&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;Value&#34;</span>: <span style=color:#ba2121>&#34;false&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;Name&#34;</span>: <span style=color:#ba2121>&#34;ALBGODEMO&#34;</span>,
</span></span></code></pre></div><p>Where <code>LB8A12904C</code> is the <strong>Logical ID</strong>.</p><p>We define the Unit Test for that in GO:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:green;font-weight:700>func</span> <span style=color:#00f>TestAlbInstStack</span>(t <span style=color:#666>*</span>testing.T) {
</span></span><span style=display:flex><span>	<span style=color:#408080;font-style:italic>// GIVEN
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>	app <span style=color:#666>:=</span> awscdk.<span style=color:#00f>NewApp</span>(<span style=color:green;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#408080;font-style:italic>// WHEN
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>	stack <span style=color:#666>:=</span> alb_ec2.<span style=color:#00f>NewAlbEC2Stack</span>(app, <span style=color:#ba2121>&#34;MyStack&#34;</span>, <span style=color:green;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#408080;font-style:italic>// THEN
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>	bytes, err <span style=color:#666>:=</span> json.<span style=color:#00f>Marshal</span>(app.<span style=color:#00f>Synth</span>(<span style=color:green;font-weight:700>nil</span>).<span style=color:#00f>GetStackArtifact</span>(stack.<span style=color:#00f>ArtifactId</span>()).<span style=color:#00f>Template</span>())
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:green;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>			t.<span style=color:#00f>Error</span>(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  <span style=color:#408080;font-style:italic>// Check
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>	template <span style=color:#666>:=</span> gjson.<span style=color:#00f>ParseBytes</span>(bytes)
</span></span><span style=display:flex><span>	albName <span style=color:#666>:=</span> template.<span style=color:#00f>Get</span>(<span style=color:#ba2121>&#34;Resources.LB8A12904C.Properties.Name&#34;</span>).<span style=color:#00f>String</span>()
</span></span><span style=display:flex><span>	assert.<span style=color:#00f>Equal</span>(t, <span style=color:#ba2121>&#34;ALBGODEMO&#34;</span>, albName)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>Given: An CDK app is created</li><li>When: The stack is created</li><li>Then: The data structure &ldquo;StackArtifact&rdquo; is translated to json. This is called &ldquo;marshaling&rdquo;</li><li>Check: the gson library is used to parse the json file</li></ol><p>This is the part which you also can do in TS/Python. The <code>cdk init app</code> generates a test skeleton for you.</p><p>How do you know the name &ldquo;LB8A12904C&rdquo;? - Answer is you don&rsquo;t. You have to synthesize once and take the Logical ID out of the template file.</p><p>We run the test:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go <span style=color:green>test</span> -run TestAlbInstStack -v
</span></span><span style=display:flex><span><span style=color:#666>===</span> RUN   TestAlbInstStack
</span></span><span style=display:flex><span>--- PASS: TestAlbInstStack <span style=color:#666>(</span>7.82s<span style=color:#666>)</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok  	alb_ec2	8.430s
</span></span></code></pre></div><p>This test can not only be used for testing created parameters e.g. for the albName. It also proofs that the build process runs without errors. Try it out and change the name of the Load Balancer or change the Construct ID. The test will FAIL.</p><p>In TypeScript this test would look like:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span>test(<span style=color:#ba2121>&#39;Load Balancer exists&#39;</span>, () <span style=color:#666>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> app <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> cdk.App();
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// WHEN
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>const</span> stack <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> AlbEc2.AlbEc2Stack(app, <span style=color:#ba2121>&#39;MyTestStack&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// THEN
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>const</span> actual <span style=color:#666>=</span> app.synth().getStackArtifact(stack.artifactId).template;
</span></span><span style=display:flex><span>    expect(actual.Resources.LB8A12904C.Type).toEqual(<span style=color:#ba2121>&#34;AWS::ElasticLoadBalancingV2::LoadBalancer&#34;</span>)
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>To be exact this TypeScript test only checks the Type, not the property.</p><p>Currently, the integration and applications tests are failing:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go <span style=color:green>test</span>  -v
</span></span><span style=display:flex><span><span style=color:#666>===</span> RUN   TestALBRequest
</span></span><span style=display:flex><span>    ssm.go:18:
</span></span><span style=display:flex><span>        	Error Trace:	ssm.go:18
</span></span><span style=display:flex><span>        	            				alb_ec2_test.go:35
</span></span><span style=display:flex><span>        	Error:      	Received unexpected error:
</span></span><span style=display:flex><span>        	            	ParameterNotFound:
</span></span><span style=display:flex><span>        	            		status code: 400, request id: a9b1f50b-c462-4b9b-9bf4-72fbb4768114
</span></span><span style=display:flex><span>        	Test:       	TestALBRequest
</span></span><span style=display:flex><span>--- FAIL: TestALBRequest <span style=color:#666>(</span>0.37s<span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#666>===</span> RUN   TestAlbPhysicalResource
</span></span><span style=display:flex><span>FATA<span style=color:#666>[</span>0000<span style=color:#666>]</span> Template AlbInstStack not found
</span></span><span style=display:flex><span><span style=color:green>exit</span> status <span style=color:#666>1</span>
</span></span><span style=display:flex><span>FAIL	alb_ec2	1.145s
</span></span></code></pre></div><p>This is correct because we do not have a physical resource for the Load Balancer yet.</p><p><img src=/img/2021/06/unit-test.png alt=Mapping></p><p>We have tested the CloudFormation Template with a Unit test.</p><p>With a <code>cdk deploy</code> the template is sent to the CloudFormation service. CloudFormation generates the Stack, which includes the physical resource &ldquo;load balancer&rdquo;. I think it&rsquo;s funny to talk about &ldquo;physical&rdquo; resources in the Cloud, but that is the AWS wording :).</p><h3 id=2-taste-integration-test><strong>2 Taste: Integration test</strong></h3><p>Now with <code>cdk deploy</code> the resources are generated. CDK adds all necessary auxiliary resources, which the Load Balancer needs to work.<br>So we do not have to define everything in the Construct. All the physical resources together build the CloudFormation stack.</p><p>Different resources from the stack can have different states during creation:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>cdkstat AlbInstStack
</span></span><span style=display:flex><span>Logical ID                       Pysical ID                       Type                             Status
</span></span><span style=display:flex><span>----------                       ----------                       -----------                      -----------
</span></span><span style=display:flex><span>ASG46ED3070                      autoscalingGroupCDKDEMO          AWS::AutoScaling::AutoScalingGr  CREATE_IN_PROGRESS
</span></span><span style=display:flex><span>ASGInstanceProfile0A2834D7       AlbInstStack-ASGInstanceProfile  AWS::IAM::InstanceProfile        CREATE_COMPLETE
</span></span><span style=display:flex><span>ASGInstanceSecurityGroup0525485  sg-0bb8c50c146e319d7             AWS::EC2::SecurityGroup          CREATE_COMPLETE
</span></span><span style=display:flex><span>ASGInstanceSecurityGroupfromAlb  ASGInstanceSecurityGroupfromAlb  AWS::EC2::SecurityGroupIngress   CREATE_COMPLETE
</span></span><span style=display:flex><span>ASGLaunchConfigC00AF12B          AlbInstStack-ASGLaunchConfigC00  AWS::AutoScaling::LaunchConfigu  CREATE_COMPLETE
</span></span><span style=display:flex><span>CDKMetadata                      d650d230-cfa0-11eb-b478-06e6f2d  AWS::CDK::Metadata               CREATE_IN_PROGRESS
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Each resource in the CloudFormation stack starts with the state <code>CREATE_IN_PROGRESS</code>and hopefully ends with <code>CREATE_COMPLETE</code></p><p>When all resources have the state <code>CREATE_COMPLETE</code>, the stack is completed. The Load Balancer should be created. To be sure, we test that.</p><p>The test for the physical resource looks like:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:green;font-weight:700>func</span> <span style=color:#00f>TestAlbPhysicalResource</span>( t <span style=color:#666>*</span>testing.T){
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>if</span> testing.<span style=color:#00f>Short</span>() {
</span></span><span style=display:flex><span>        t.<span style=color:#00f>Skip</span>(<span style=color:#ba2121>&#34;skipping integration test in short mode.&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	alb, err <span style=color:#666>:=</span> citalbv2.<span style=color:#00f>GetLoadBalancer</span>(aws.<span style=color:#00f>String</span>(<span style=color:#ba2121>&#34;AlbInstStack&#34;</span>), aws.<span style=color:#00f>String</span>(<span style=color:#ba2121>&#34;LB&#34;</span>))
</span></span><span style=display:flex><span>	assert.<span style=color:#00f>NilError</span>(t,err,<span style=color:#ba2121>&#34;The LoadBalancer should be retrievable without error&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#408080;font-style:italic>// Just read anything from alb
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>	applicationType <span style=color:#666>:=</span> awselbv2types.LoadBalancerTypeEnumApplication
</span></span><span style=display:flex><span>	assert.<span style=color:#00f>Equal</span>(t, applicationType, alb.Type)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>GetLoadBalancer</code> takes care of the translation from &ldquo;Construct with ID <strong>LB</strong> from Stack <strong>AlbInstStack</strong>&rdquo; to an <a href=https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/elasticloadbalancingv2/types#LoadBalancer>Load Balancer data structure </a>.</p><p>With the AWS cli call:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws cloudformation describe-stack-resource  --stack-name AlbInstStack --logical-resource-id LB8A12904C
</span></span></code></pre></div><p>you can see the CloudFormation data of the physical resource:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>  <span style=color:#ba2121>&#34;StackResourceDetail&#34;</span><span>:</span> {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;StackName&#34;</span>: <span style=color:#ba2121>&#34;AlbInstStack&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;StackId&#34;</span>: <span style=color:#ba2121>&#34;arn:aws:cloudformation:eu-central-1:555544446666:stack/AlbInstStack/d650d230-cfa0-11eb-b478-06e6f2d05224&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;LogicalResourceId&#34;</span>: <span style=color:#ba2121>&#34;LB8A12904C&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;PhysicalResourceId&#34;</span>: <span style=color:#ba2121>&#34;arn:aws:elasticloadbalancing:eu-central-1:555544446666:loadbalancer/app/ALBGODEMO/fa33a9bde8742fe6&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;ResourceType&#34;</span>: <span style=color:#ba2121>&#34;AWS::ElasticLoadBalancingV2::LoadBalancer&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;LastUpdatedTimestamp&#34;</span>: <span style=color:#ba2121>&#34;2021-06-17T19:22:01.310000+00:00&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;ResourceStatus&#34;</span>: <span style=color:#ba2121>&#34;CREATE_COMPLETE&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;Metadata&#34;</span>: <span style=color:#ba2121>&#34;{\&#34;aws:cdk:path\&#34;:\&#34;AlbInstStack/LB/Resource\&#34;}&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;DriftInformation&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;StackResourceDriftStatus&#34;</span>: <span style=color:#ba2121>&#34;NOT_CHECKED&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>The <code>citalbv2.GetLoadBalancer</code> uses this CloudFormation data to get the Load Balancer Data with the GO SDK.</p><p>Let us have a look at the physical test:</p><ol><li><code>if testing.Short()</code></li></ol><p>If you call <code>go test -short</code> the short flag will be set and the test will be skipped. This is useful if you not have deployed the stack yet, so you know the test will fail.</p><ol start=2><li><p>The <code>assert.NilError</code> checks wether the resource is really there.</p></li><li><p>Check fields, <code>applicationType := awselbv2types.LoadBalancerTypeEnumApplication</code>
As an example the type is checked whether it is really is an Application Load Balancer.</p></li></ol><p>So you can check for the data fields of the resource itself - not the CloudFormation data.</p><p>Some of the data fields are:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>AvailabilityZones []AvailabilityZone
</span></span><span style=display:flex><span>CanonicalHostedZoneId <span style=color:#666>*</span><span style=color:#b00040>string</span>
</span></span><span style=display:flex><span>CreatedTime <span style=color:#666>*</span>time.Time
</span></span><span style=display:flex><span>IpAddressType IpAddressType 
</span></span><span style=display:flex><span>LoadBalancerArn <span style=color:#666>*</span><span style=color:#b00040>string</span>
</span></span><span style=display:flex><span>LoadBalancerName <span style=color:#666>*</span><span style=color:#b00040>string</span>
</span></span><span style=display:flex><span>SecurityGroups []<span style=color:#b00040>string</span>
</span></span><span style=display:flex><span>State <span style=color:#666>*</span>LoadBalancerState
</span></span><span style=display:flex><span>Type LoadBalancerTypeEnum
</span></span></code></pre></div><p>If you want to test some connected resources, you retrieve them with the SDK.
If you want to check how many Security Groups are attached, you do that directly on <code>SecurityGroups []string</code> with <code>len(alb.SecurityGroups)</code>.</p><p>The shortest integration test - check for existence - is just:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>alb, err <span style=color:#666>:=</span> citalbv2.<span style=color:#00f>GetLoadBalancer</span>(aws.<span style=color:#00f>String</span>(<span style=color:#ba2121>&#34;AlbInstStack&#34;</span>), aws.<span style=color:#00f>String</span>(<span style=color:#ba2121>&#34;LB&#34;</span>))
</span></span><span style=display:flex><span>assert.<span style=color:#00f>NilError</span>(t,err,<span style=color:#ba2121>&#34;The LoadBalancer should be retrievable without error&#34;</span>)
</span></span></code></pre></div><p>To separate the test levels, you could also use tags in GO. You use different files for the
tests and tag them like:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#408080;font-style:italic>// +build integration
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>package</span> alb_ec2
</span></span></code></pre></div><p>to include.</p><p>With <code>go test --tags=integration</code> you would only run test files tagged with <code>integration</code></p><p>This test written in GO can also be applied to CDK generated CloudFormation stacks from other programming languages!
At first sight, the idea to write a test in a different language seems strange. But this is the same as what you would do if using <a href=https://www.chef.io/products/chef-inspec>Chef inspec</a> which uses Ruby. The difference is that you do not use a DSL (Domain Specific Language), but directly work on the AWS GO SDK. With a DSL you have limited possibilities, which the SDK you can test anything.</p><p><img src=/img/2021/06/cit-test.png alt=cit></p><p>We have tested the physical Load Balancer resource with an integration test.</p><h3 id=3-feel-application-test><strong>3 Feel: Application Test</strong></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:green;font-weight:700>func</span> <span style=color:#00f>TestALBRequest</span>(t <span style=color:#666>*</span>testing.T) {
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>if</span> testing.<span style=color:#00f>Short</span>() {
</span></span><span style=display:flex><span>        t.<span style=color:#00f>Skip</span>(<span style=color:#ba2121>&#34;skipping integration test in short mode.&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	storedUrl <span style=color:#666>:=</span> terratest_aws.<span style=color:#00f>GetParameter</span>(t,region,<span style=color:#ba2121>&#34;/cdk-templates/go/alb_ec2&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	url <span style=color:#666>:=</span> fmt.<span style=color:#00f>Sprintf</span>(<span style=color:#ba2121>&#34;http://%s&#34;</span>, storedUrl)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	sleepBetweenRetries, <span style=color:#b00040>error</span> <span style=color:#666>:=</span> time.<span style=color:#00f>ParseDuration</span>(<span style=color:#ba2121>&#34;10s&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>if</span> <span style=color:#b00040>error</span> <span style=color:#666>!=</span> <span style=color:green;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:green>panic</span>(<span style=color:#ba2121>&#34;Can&#39;t parse duration&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	http_helper.<span style=color:#00f>HttpGetWithRetry</span>(t, url, <span style=color:green;font-weight:700>nil</span>, <span style=color:#666>200</span> , <span style=color:#ba2121>&#34;&lt;h1&gt;hello world&lt;/h1&gt;&#34;</span>, <span style=color:#666>20</span>, sleepBetweenRetries)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is almost the same as in <a href=/2021/05/cit-build-cdk-infrastructure-testing-part-1-terratest-and-the-integrated-integration.html>part1 blogpost</a>. We are using terratest to send http requests. If we want the test for certain data in the response, you can add a helper function.
See <a href=https://github.com/gruntwork-io/terratest/tree/master/modules/http-helper>https://github.com/gruntwork-io/terratest/tree/master/modules/http-helper</a> for more details.</p><p><img src=/img/2021/06/app.png alt=App></p><p>We have tested the application.</p><h2 id=the-cit-lib>The CIT lib</h2><p>This is a GO implementation of the concept to take the CDK Construct ID as the identifier for all test levels. If you want to code it in <em>your</em> language, this should be doable with these hints.</p><p>You can use the GO module from <a href=https://github.com/megaproaktiv/cit>https://github.com/megaproaktiv/cit</a></p><h3 id=how-do-you-get-the-physical-id-from-the-construct-id>How do you get the physical ID from the Construct id?</h3><p>Let us have a look at the ALb CloudFormation:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#ba2121>&#34;LB8A12904C&#34;</span><span>:</span> {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;Type&#34;</span>: <span style=color:#ba2121>&#34;AWS::ElasticLoadBalancingV2::LoadBalancer&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;Properties&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;LoadBalancerAttributes&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>&#34;Key&#34;</span>: <span style=color:#ba2121>&#34;deletion_protection.enabled&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>&#34;Value&#34;</span>: <span style=color:#ba2121>&#34;false&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span><span>...</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;Metadata&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;aws:cdk:path&#34;</span>: <span style=color:#ba2121>&#34;AlbStack/LB/Resource&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span></code></pre></div><p>To know which Construct belongs to which resource, the CDK has to maintain the mapping state.
It is stored in the Metadata:</p><p><code>"aws:cdk:path": "AlbStack/LB/Resource"</code></p><p>The first part is the stack-name, the second is the Construct id, then &ldquo;Resource&rdquo;.</p><h3 id=the-algorithm>The algorithm:</h3><ol><li>Get the template from CloudFormation with the template name and the <code>GetTemplate</code> API call</li><li>Find the ConstructID name from the metadata. <code>AlbStack/LB/Resource</code></li><li>Get the Logical ID from the Resource <code>LB8A12904C</code></li><li>Call the <code>DescribeStackResource</code> API call with the Logical ID - this will give you the Physical ID</li></ol><p>See the GO code: <a href=https://github.com/megaproaktiv/cit/blob/main/getphysical.go>PhysicalIDfromCID</a></p><ol><li>Get template</li></ol><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	resGetTemplate, err <span style=color:#666>:=</span> client.<span style=color:#00f>GetTemplate</span>(context.<span style=color:#00f>TODO</span>(), parameterStack)
</span></span></code></pre></div><ol start=2><li>/ 3. Find Cid / Get the Logical ID</li></ol><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:green;font-weight:700>for</span> key, resource <span style=color:#666>:=</span> <span style=color:green;font-weight:700>range</span> stack.Resources {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> resource.Metadata <span style=color:#666>!=</span> <span style=color:green;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>if</span> resource.Metadata[<span style=color:#ba2121>&#34;aws:cdk:path&#34;</span>] <span style=color:#666>!=</span> <span style=color:#ba2121>&#34;&#34;</span> {
</span></span><span style=display:flex><span>      meta <span style=color:#666>:=</span> resource.Metadata[<span style=color:#ba2121>&#34;aws:cdk:path&#34;</span>]
</span></span><span style=display:flex><span>      log.<span style=color:#00f>Debug</span>(<span style=color:#ba2121>&#34;Path: &#34;</span>,meta)
</span></span><span style=display:flex><span>      templateConstructID <span style=color:#666>:=</span> <span style=color:#00f>ExtractConstructID</span>(<span style=color:#666>&amp;</span>meta)
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>if</span> templateConstructID <span style=color:#666>==</span> <span style=color:#666>*</span>constructID {
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>return</span> <span style=color:#666>&amp;</span>key, <span style=color:green;font-weight:700>nil</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>DescribeStackResource</li></ol><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>resourceDetail,err <span style=color:#666>:=</span> client.<span style=color:#00f>DescribeStackResource</span>(context.<span style=color:#00f>TODO</span>(), parameterResource)
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:green;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>nil</span>, err
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// find physicalid
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>physicalId <span style=color:#666>:=</span> resourceDetail.StackResourceDetail.PhysicalResourceId
</span></span></code></pre></div><h3 id=low-level-helper-functions>Low Level helper functions</h3><p>If you want to check any AWS resource, you can use the <code>PhysicalIDfromCID</code> function, which implements the matching.
When you insist on not using go, just implement it for the language and testing framework of your choice.</p><h3 id=higher-abstraction>Higher Abstraction</h3><p>During the last weeks, i implemented functions like</p><ul><li>GetLoadBalancer</li><li>GetUser (iam)</li><li>GetVpc, GetSecurityGroup
and of course for Lambda</li><li>GetFunctionConfiguration</li></ul><p>Although it is easy to implement the function for several resources, a simpler call like just <code>GetLoadBalancer</code> is nice. Please contact me for adding other resources, because there are <em>many resources</em> and I will not add all of them in this lifetime.</p><p>In the next part we will apply this to Lambda functions.</p><h2 id=the-end>The End</h2><p>The integration of all test types together has many advantages in my opinion. What is your opinion on this? Is it helpful for your project? I would be happy to hear your experiences!</p><p>I hope this concept or the cit framework implementation will help you with your projects also.
For the last couple of projects, I started with an integrated or application test and found it quite useful to get the rights results and staying focused.</p><p>Some of the other integration test i used were:</p><ul><li>AWS Workspaces and Workspaces User creation</li><li>AWS Transfer sftp User and read/write test</li><li>Application Load Balancer with Domain and installed software</li></ul><p>For discussion please contact me on twitter @megaproaktiv</p><h2 id=appendix>Appendix</h2><p>The repositories</p><p>Cit - CDK Integration Testing</p><ul><li><a href=https://github.com/megaproaktiv/cit>https://github.com/megaproaktiv/cit</a></li></ul><p>cdkstat - Show CloudFormation Stack status</p><ul><li><a href=https://github.com/megaproaktiv/cdkstats>https://github.com/megaproaktiv/cdkstats</a></li></ul><p>CDK Templates using CIT and terratest for testing</p><ul><li><a href=https://github.com/tecracer/cdk-templates>https://github.com/tecracer/cdk-templates</a></li></ul><p>Terratest</p><p><a href=https://terratest.gruntwork.io/docs/getting-started/quick-start/>Quick Start</a></p><ul><li><a href=https://github.com/gruntwork-io/terratest>https://github.com/gruntwork-io/terratest</a></li></ul><p>The tools</p><p>Awsume</p><ul><li><a href=https://awsu.me>awsume</a></li><li><a href=https://taskfile.dev/#/>Taskfile</a></li></ul><h2 id=thanks>Thanks</h2><p>Photo by Nathan Dumlao on Unsplash</p></div></div></article><article class=uk-article><div class=container><section class=author-box itemprop=author itemscope itemtype=https://schema.org/Person></section></div></article></main></div><div id=tm-footer class=tm-footer><div id=tm-footer class="tm-footer tm-footer-margin-top"><div class="uk-panel uk-panel-space uk-text-center"><p>Copyright © 2018-today by <a href=https://chef.tecracer.de/ target=_blank>tecRacer</a></p></div></div></div><div id=offcanvas class=uk-offcanvas aria-hidden=true><div class="uk-offcanvas-bar uk-offcanvas-bar-flip"><div class="uk-panel uk-text-center"><a href=https://tecracer-chef.github.io/></a>
<img src=https://tecracer-chef.github.io/img/logo/logo-tr.png alt></a></div><ul class="uk-nav uk-nav-offcanvas"><li><a href=/ title>Blog</a></li><li><a href=/authors title>Authors</a></li><li><a href=/github/github-prs.html title>Pull Requests</a></li></ul></div></div></div></body></html>